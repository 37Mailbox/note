<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Smartisan Notes Pro</title>
    <!-- å­—ä½“å¼•ç”¨ï¼šå¢åŠ éœé¹œæ–‡æ¥·ï¼Œç§»é™¤æ‚ä¹±ä¹¦æ³• -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;700;900&family=Noto+Sans+SC:wght@400;700&family=ZCOOL+XiaoWei&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lxgw-wenkai-screen-webfont@1.1.0/style.css" />
    
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://unpkg.com/leancloud-storage@4.15.0/dist/av-min.js"></script>
    
    <style>
        :root { --primary-red: #d95e48; --bg-pc: #3d3d3d; --sidebar-dark: #2d2d2d; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body, html { margin: 0; padding: 0; height: 100%; width: 100%; background: #f0f0f0; font-family: "PingFang SC", sans-serif; overflow: hidden; }
        
        #app { height: 100vh; width: 100vw; display: flex; color: #333; }

        /* --- é€šç”¨ï¼šé®ç½©å±‚ --- */
        .mask { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; gap: 15px; }
        .auth-mask { background: var(--bg-pc); }
        .auth-card { background: #f2f2f2; width: 90%; max-width: 340px; border-radius: 12px; overflow: hidden; box-shadow: 0 20px 60px rgba(0,0,0,0.5); }
        .auth-header { background: var(--primary-red); padding: 25px; text-align: center; color: white; }
        .auth-body { padding: 25px; }
        .auth-input { width: 100%; padding: 14px; margin-bottom: 12px; border: 1px solid #ccc; border-radius: 6px; font-size: 16px; }
        .auth-btn { width: 100%; padding: 14px; background: var(--primary-red); color: white; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; }

        /* --- å¸ƒå±€ Aï¼šç”µè„‘ç«¯ (PC) --- */
        .pc-layout { display: flex; width: 100%; height: 100%; }
        .pc-sidebar { width: 320px; background: var(--sidebar-dark); display: flex; flex-direction: column; border-right: 1px solid #1a1a1a; }
        .pc-main { flex: 1; background: #e5e5e5; display: flex; flex-direction: column; position: relative; overflow-y: auto; padding: 40px 20px; align-items: center; }
        
        /* --- å¸ƒå±€ Bï¼šç§»åŠ¨ç«¯ (Mobile) --- */
        .mobile-layout { width: 100%; height: 100%; display: flex; flex-direction: column; background: #fff; }
        .mobile-header { height: 50px; background: #f8f8f8; border-bottom: 1px solid #ddd; display: flex; align-items: center; padding: 0 15px; justify-content: space-between; }
        .mobile-content { flex: 1; overflow-y: auto; }
        .mobile-list { height: 100%; overflow-y: auto; background: #fff; }

        /* --- ä¾¿ç­¾åˆ—è¡¨æ ·å¼ --- */
        .list-header { padding: 20px; border-bottom: 1px solid #3a3a3a; display: flex; justify-content: space-between; align-items: center; color: #eee; }
        .note-item { padding: 18px 20px; border-bottom: 1px solid #333; cursor: pointer; transition: 0.2s; }
        .note-item.active { background: #3d3d3d; border-left: 4px solid var(--primary-red); }
        .note-item .t { color: #eee; font-size: 14px; font-weight: bold; margin-bottom: 5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .note-item .s { color: #888; font-size: 12px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        
        /* ç§»åŠ¨ç«¯åˆ—è¡¨é¡¹ */
        .m-note-item { padding: 15px; border-bottom: 1px solid #eee; }
        .m-note-item .t { font-size: 16px; font-weight: bold; margin-bottom: 4px; }
        .m-note-item .s { font-size: 13px; color: #888; }

        /* --- ç¼–è¾‘çº¸å¼ æ ·å¼ --- */
        .paper { 
            width: 100%; max-width: 600px; min-height: 800px; 
            background: #fff; box-shadow: 0 10px 30px rgba(0,0,0,0.1); 
            display: flex; flex-direction: column; transition: 0.3s;
        }
        .paper-body { padding: 40px 45px; flex: 1; }
        .input-title { width: 100%; border: none; background: transparent; font-size: 28px; font-weight: 900; margin-top: 10px; margin-bottom: 20px; font-family: inherit; }
        .input-content { width: 100%; border: none; background: transparent; font-size: 18px; line-height: 1.8; resize: none; min-height: 600px; font-family: inherit; text-align: justify; }

        /* --- å¯¼å‡ºä¸“ç”¨å¤´ --- */
        .export-header { padding: 60px 45px 20px 45px; border-bottom: 1px solid rgba(0,0,0,0.05); margin-bottom: 20px; }
        .export-title { font-size: 30px; font-weight: 900; }

        /* --- å­—ä½“/ä¸»é¢˜å®šä¹‰ --- */
        .theme-white { background: #fff !important; color: #333; }
        .theme-grid { background-color: #f9fbfd !important; background-image: url("data:image/svg+xml,%3Csvg width='24' height='24' viewBox='0 0 24 24' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M24 0v24H0' stroke='%23000' stroke-opacity='0.04' stroke-width='0.5' fill='none'/%3E%3C/svg%3E") !important; }
        .theme-retro { background-color: #fcf5e5 !important; color: #5c4b37; }
        .theme-kraft { background-color: #e6d5b8 !important; color: #4a3e2e !important; }
        
        .font-sans { font-family: "Noto Sans SC", sans-serif; }
        .font-wenkai { font-family: "LXGW WenKai Screen", sans-serif; }
        .font-serif { font-family: "Noto Serif SC", serif; }

        /* --- å·¥å…·æ  --- */
        .toolbar { position: fixed; bottom: 30px; right: 30px; display: flex; flex-direction: column; gap: 12px; z-index: 1000; }
        .fab { width: 54px; height: 54px; border-radius: 50%; background: #fff; border: none; box-shadow: 0 4px 15px rgba(0,0,0,0.2); cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 22px; }
        .fab.primary { background: var(--primary-red); color: white; }
        
        .style-panel { position: absolute; bottom: 70px; right: 0; background: #fff; width: 240px; padding: 20px; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); }
        .dot-row { display: flex; gap: 8px; margin: 10px 0 20px 0; }
        .dot { width: 30px; height: 30px; border-radius: 4px; border: 2px solid #eee; cursor: pointer; }
        .dot.active { border-color: var(--primary-red); }

        /* å¯¼å‡ºåŒºç¦»å± */
        #staging { position: absolute; left: -9999px; width: 500px; }
    </style>
</head>
<body>

<div id="app">
    <!-- 1. ç™»å½•é€»è¾‘ -->
    <div class="mask auth-mask" v-if="!user">
        <div class="auth-card">
            <div class="auth-header"><h3>Smartisan Notes Pro</h3></div>
            <div class="auth-body">
                <input class="auth-input" v-model="auth.u" placeholder="ç”¨æˆ·å">
                <input class="auth-input" type="password" v-model="auth.p" placeholder="å¯†ç ">
                <button class="auth-btn" @click="handleAuth">{{ isReg ? 'æ³¨å†Œå¹¶ç™»å½•' : 'ç«‹å³ç™»å½•' }}</button>
                <p @click="isReg=!isReg" style="text-align:center; font-size:12px; color:#888; cursor:pointer; margin-top:15px;">
                    {{ isReg ? 'å·²æœ‰è´¦å·ï¼Ÿå»ç™»å½•' : 'æ²¡æœ‰è´¦å·ï¼Ÿç‚¹å‡»æ³¨å†Œ' }}
                </p>
            </div>
        </div>
    </div>

    <!-- 2. å…¨å±€åŠ è½½çŠ¶æ€ -->
    <div class="mask" v-if="loading || processing">
        <div style="font-size:30px;">{{ processing ? 'âœ¨' : 'â˜ï¸' }}</div>
        <div>{{ processing ? 'æ­£åœ¨ç”Ÿæˆé•¿å›¾...' : 'åŒæ­¥æ•°æ®ä¸­...' }}</div>
    </div>

    <!-- 3. ä¸»ç•Œé¢å¸ƒå±€ -->
    
    <!-- ç”µè„‘ç«¯ï¼šåŒæ  -->
    <div v-if="!isMobile && user" class="pc-layout">
        <div class="pc-sidebar">
            <div class="list-header">
                <span>æˆ‘çš„ä¾¿ç­¾ ({{notes.length}})</span>
                <button @click="createNote" style="background:var(--primary-red); color:#fff; border:none; padding:4px 12px; border-radius:4px; font-weight:bold;">+ æ–°å»º</button>
            </div>
            <div style="flex:1; overflow-y:auto;">
                <div class="note-item" v-for="n in notes" :key="n.id" :class="{active: currentNote?.id == n.id}" @click="openNote(n)">
                    <div class="t">{{ n.get('title') || 'æ— æ ‡é¢˜' }}</div>
                    <div class="s">{{ n.get('content') || 'æš‚æ— å†…å®¹...' }}</div>
                </div>
            </div>
            <div @click="logout" style="padding:15px; color:#666; font-size:12px; cursor:pointer; text-align:center;">é€€å‡ºç™»å½•</div>
        </div>
        <div class="pc-main" v-if="currentNote">
            <div style="margin-bottom:10px; font-size:12px; color:#888;">{{ saveStatus }}</div>
            <div class="paper" :class="[currentNote.get('theme') || 'theme-white', currentNote.get('font') || 'font-sans']">
                <div class="paper-body">
                    <input class="input-title" v-model="editorData.title" @input="triggerSave" placeholder="è¾“å…¥æ ‡é¢˜">
                    <textarea ref="editor" class="input-content" v-model="editorData.content" @input="onInput" placeholder="å†™ç‚¹ä»€ä¹ˆ..."></textarea>
                </div>
            </div>
        </div>
    </div>

    <!-- ç§»åŠ¨ç«¯ï¼šå•æ å…¨å±åˆ‡æ¢ -->
    <div v-if="isMobile && user" class="mobile-layout">
        <!-- åˆ—è¡¨è§†å›¾ -->
        <div v-if="!currentNote" class="mobile-list">
            <div class="mobile-header">
                <span style="font-weight:bold;">æˆ‘çš„ä¾¿ç­¾</span>
                <button @click="createNote" style="color:var(--primary-red); background:none; border:none; font-size:16px; font-weight:bold;">+ æ–°å»º</button>
            </div>
            <div class="m-note-item" v-for="n in notes" :key="n.id" @click="openNote(n)">
                <div class="t">{{ n.get('title') || 'æ— æ ‡é¢˜' }}</div>
                <div class="s">{{ n.get('content') || 'æš‚æ— å†…å®¹...' }}</div>
            </div>
            <div @click="logout" style="padding:30px; text-align:center; color:#999; font-size:12px;">é€€å‡ºè´¦å·</div>
        </div>
        <!-- ç¼–è¾‘è§†å›¾ -->
        <div v-else style="height:100%; display:flex; flex-direction:column;">
            <div class="mobile-header">
                <button @click="closeNote" style="color:var(--primary-red); background:none; border:none; font-size:16px;">â€¹ åˆ—è¡¨</button>
                <span style="font-size:12px; color:#999;">{{ saveStatus }}</span>
                <button @click="deleteNote" style="color:#999; background:none; border:none;">åˆ é™¤</button>
            </div>
            <div class="mobile-content" :class="[currentNote.get('theme'), currentNote.get('font')]">
                <div style="padding:20px;">
                    <input class="input-title" v-model="editorData.title" @input="triggerSave" placeholder="æ ‡é¢˜">
                    <textarea ref="editor" class="input-content" v-model="editorData.content" @input="onInput" placeholder="å†™ç‚¹ä»€ä¹ˆ..."></textarea>
                </div>
            </div>
        </div>
    </div>

    <!-- é€šç”¨å·¥å…·æ  (ä»…åœ¨ç¼–è¾‘æ—¶æ˜¾ç¤º) -->
    <div class="toolbar" v-if="currentNote">
        <div class="style-panel" v-if="showStyle">
            <div style="font-size:11px; color:#999;">åˆ‡æ¢ä¿¡çº¸</div>
            <div class="dot-row">
                <div v-for="t in themes" :key="t" :class="['dot', t, {active: currentNote.get('theme')==t}]" @click="updateAttr('theme', t)"></div>
            </div>
            <div style="font-size:11px; color:#999; margin-top:10px;">é€‰æ‹©å­—ä½“</div>
            <select v-model="editorData.font" @change="updateAttr('font', editorData.font)" style="width:100%; margin-top:5px; padding:5px;">
                <option value="font-sans">æ ‡å‡†é»‘ä½“</option>
                <option value="font-wenkai">éœé¹œæ–‡æ¥·</option>
                <option value="font-serif">ç»å…¸å®‹ä½“</option>
            </select>
            <div style="font-size:11px; color:#999; margin-top:10px;">é•¿å›¾åˆ†æ®µ</div>
            <select v-model="splitCount" style="width:100%; margin-top:5px; padding:5px;">
                <option :value="1">ä¸åˆ‡åˆ† (å•å¼ )</option>
                <option :value="2">æ™ºèƒ½åˆ‡ 2 å¼ </option>
                <option :value="3">æ™ºèƒ½åˆ‡ 3 å¼ </option>
            </select>
        </div>
        <button class="fab" @click="showStyle=!showStyle">ğŸ¨</button>
        <button v-if="!isMobile" class="fab" @click="deleteNote">ğŸ—‘ï¸</button>
        <button class="fab primary" @click="exportImages">âœ¨</button>
    </div>

    <!-- ç¦»å±æ¸²æŸ“ -->
    <div id="staging"></div>
</div>

<script>
const { createApp, ref, onMounted, nextTick, reactive, watch } = Vue;

const CONFIG = {
    appId: 'E1rPatvQJfGDx7FnsXpGTHN1-gzGzoHsz',
    appKey: 'eqfKH55tCL5dh3oWqF0KkomM',
    serverURL: 'https://e1rpatvq.lc-cn-n1-shared.com'
};

createApp({
    setup() {
        const user = ref(null);
        const auth = reactive({ u: '', p: '' });
        const isReg = ref(false);
        const loading = ref(false);
        const processing = ref(false);
        const isMobile = ref(window.innerWidth < 1024);
        
        const notes = ref([]);
        const currentNote = ref(null);
        const editorData = reactive({ title: '', content: '', theme: '', font: '' });
        const saveStatus = ref('å·²åŒæ­¥äº‘ç«¯');
        let saveTimer = null;

        const showStyle = ref(false);
        const splitCount = ref(1);
        const themes = ['theme-white', 'theme-grid', 'theme-retro', 'theme-kraft'];
        const editor = ref(null);

        onMounted(() => {
            AV.init(CONFIG);
            user.value = AV.User.current();
            if (user.value) loadNotes();
            window.addEventListener('resize', () => isMobile.value = window.innerWidth < 1024);
        });

        const handleAuth = async () => {
            if (!auth.u || !auth.p) return alert("è¯·è¾“å…¥å®Œæ•´ä¿¡æ¯");
            loading.value = true;
            try {
                if (isReg.value) {
                    const u = new AV.User();
                    u.setUsername(auth.u); u.setPassword(auth.p);
                    user.value = await u.signUp();
                } else {
                    user.value = await AV.User.logIn(auth.u, auth.p);
                }
                loadNotes();
            } catch (e) { alert("ç™»å½•å¤±è´¥ï¼š" + e.message); }
            finally { loading.value = false; }
        };

        const loadNotes = async () => {
            loading.value = true;
            try {
                const q = new AV.Query('Note');
                q.descending('updatedAt');
                const res = await q.find();
                // æ•°æ®æ¸…æ´—ï¼šåªä¿ç•™æœ‰ ID ä¸”ä¸æ˜¯ç©ºçš„ä¾¿ç­¾
                notes.value = res.filter(n => n.id);
                
                // è‡ªåŠ¨æ¢å¤æœ€åä¸€æ¬¡ç¼–è¾‘
                const lastId = localStorage.getItem('sn_last_id');
                if (lastId) {
                    const last = notes.value.find(n => n.id === lastId);
                    if (last) openNote(last);
                }
            } finally { loading.value = false; }
        };

        const createNote = async () => {
            loading.value = true;
            try {
                const Note = AV.Object.extend('Note');
                const n = new Note();
                n.set('title', ''); n.set('content', ''); n.set('theme', 'theme-white'); n.set('font', 'font-sans');
                
                // å…³é”®ä¿®å¤ï¼šæ˜¾å¼è®¾ç½® ACL ç¡®ä¿åŒè´¦å·å…¨å¹³å°å¯è§
                const acl = new AV.ACL();
                acl.setReadAccess(user.value, true);
                acl.setWriteAccess(user.value, true);
                n.setACL(acl);

                const saved = await n.save();
                notes.value.unshift(saved);
                openNote(saved);
            } catch (e) { alert("æ–°å»ºå¤±è´¥"); }
            finally { loading.value = false; }
        };

        const openNote = (n) => {
            currentNote.value = n;
            editorData.title = n.get('title') || '';
            editorData.content = n.get('content') || '';
            editorData.theme = n.get('theme') || 'theme-white';
            editorData.font = n.get('font') || 'font-sans';
            localStorage.setItem('sn_last_id', n.id);
            nextTick(autoHeight);
        };

        const closeNote = () => { currentNote.value = null; };

        const onInput = () => { autoHeight(); triggerSave(); };
        const autoHeight = () => {
            if (editor.value) {
                editor.value.style.height = 'auto';
                editor.value.style.height = (editor.value.scrollHeight + 50) + 'px';
            }
        };

        const triggerSave = () => {
            saveStatus.ref = 'åŒæ­¥ä¸­...';
            if (saveTimer) clearTimeout(saveTimer);
            saveTimer = setTimeout(async () => {
                if (!currentNote.value) return;
                try {
                    currentNote.value.set('title', editorData.title);
                    currentNote.value.set('content', editorData.content);
                    await currentNote.value.save();
                    saveStatus.value = 'å·²åŒæ­¥äº‘ç«¯';
                } catch (e) { saveStatus.value = 'ä¿å­˜å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ'; }
            }, 1000);
        };

        const updateAttr = (k, v) => {
            if (!currentNote.value) return;
            currentNote.value.set(k, v);
            editorData[k] = v;
            triggerSave();
        };

        const deleteNote = async () => {
            if (!confirm("ç¡®å®šåˆ é™¤å—ï¼Ÿ")) return;
            try {
                const id = currentNote.value.id;
                await currentNote.value.destroy();
                notes.value = notes.value.filter(n => n.id !== id);
                currentNote.value = null;
                localStorage.removeItem('sn_last_id');
            } catch (e) { alert("åˆ é™¤å¤±è´¥"); }
        };

        const exportImages = async () => {
            processing.value = true;
            showStyle.value = false;
            const staging = document.getElementById('staging');
            staging.innerHTML = '';
            
            const count = parseInt(splitCount.value);
            const paragraphs = editorData.content.split('\n');
            const pPerPage = Math.ceil(paragraphs.length / count);

            try {
                for (let i = 0; i < count; i++) {
                    const node = document.createElement('div');
                    node.className = `paper ${editorData.theme} ${editorData.font}`;
                    node.style.boxShadow = 'none';
                    
                    let inner = '';
                    if (i === 0) {
                        inner += `<div class="export-header"><div class="export-title">${editorData.title || 'æ— æ ‡é¢˜'}</div></div>`;
                    } else {
                        inner += `<div style="height:60px"></div>`;
                    }

                    inner += '<div class="paper-body">';
                    paragraphs.slice(i * pPerPage, (i + 1) * pPerPage).forEach(p => {
                        inner += `<p style="margin-bottom:20px; font-size:18px;">${p || '<br>'}</p>`;
                    });
                    inner += '</div>';
                    
                    if (i === count - 1) inner += `<div style="text-align:center; padding:40px; opacity:0.3; font-size:12px; letter-spacing:2px;">SMARTISAN NOTES</div>`;

                    node.innerHTML = inner;
                    staging.appendChild(node);
                    await new Promise(r => setTimeout(r, 400));
                    
                    const canvas = await html2canvas(node, { scale: 2.5, useCORS: true });
                    const link = document.createElement('a');
                    link.download = `Note_${i+1}.png`;
                    link.href = canvas.toDataURL("image/png");
                    link.click();
                    staging.removeChild(node);
                }
            } catch (e) { alert("å¯¼å‡ºå¤±è´¥"); }
            finally { processing.value = false; }
        };

        const logout = () => { AV.User.logOut(); localStorage.clear(); location.reload(); };

        return {
            user, auth, isReg, loading, processing, isMobile, notes, currentNote, editorData, saveStatus, themes, showStyle, splitCount, editor,
            handleAuth, createNote, openNote, closeNote, onInput, updateAttr, triggerSave, deleteNote, exportImages, logout
        };
    }
}).mount('#app');
</script>
</body>
</html>