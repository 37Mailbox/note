<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Smartisan Notes Pro</title>
    <!-- å¼•å…¥é«˜å“è´¨å®‹ä½“ï¼Œè§£å†³å¯¼å‡ºé‡å é—®é¢˜ -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;700;900&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://unpkg.com/leancloud-storage@4.15.0/dist/av-min.js"></script>
    
    <style>
        :root { --primary-red: #d95e48; --bg-dark: #3d3d3d; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body, html { margin: 0; padding: 0; height: 100%; background: var(--bg-dark); font-family: "PingFang SC", sans-serif; overflow: hidden; }
        
        #app { display: flex; height: 100vh; width: 100vw; position: relative; }

        /* --- è®¤è¯ç•Œé¢ --- */
        .auth-mask { position: fixed; inset: 0; background: var(--bg-dark); z-index: 2000; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .auth-card { background: #f2f2f2; width: 100%; max-width: 340px; border-radius: 8px; box-shadow: 0 20px 60px rgba(0,0,0,0.5); overflow: hidden; }
        .auth-header { background: var(--primary-red); padding: 25px; text-align: center; color: white; }
        .auth-body { padding: 25px; }
        .auth-input { width: 100%; padding: 12px; margin-bottom: 12px; border: 1px solid #ccc; border-radius: 4px; outline: none; font-size: 16px; }
        .auth-btn { width: 100%; padding: 12px; background: var(--primary-red); color: white; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; }

        /* --- ä¾§è¾¹æ  --- */
        .sidebar { width: 300px; background: #2d2d2d; border-right: 1px solid #1a1a1a; display: flex; flex-direction: column; z-index: 10; transition: transform 0.3s; }
        .sidebar-header { padding: 20px; border-bottom: 1px solid #3a3a3a; display: flex; justify-content: space-between; align-items: center; }
        .sidebar-header h2 { color: #eee; font-size: 16px; margin: 0; }
        .note-list { flex: 1; overflow-y: auto; }
        .note-item { padding: 18px 20px; border-bottom: 1px solid #333; cursor: pointer; }
        .note-item.active { background: #3d3d3d; border-left: 4px solid var(--primary-red); }
        .note-item .title { color: #eee; font-size: 14px; font-weight: bold; margin-bottom: 5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .note-item .summary { color: #888; font-size: 12px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }

        /* --- ç¼–è¾‘åŒº --- */
        .main-area { flex: 1; background: #e0e0e0; display: flex; flex-direction: column; position: relative; z-index: 20; }
        .mobile-nav { display: none; height: 50px; background: #f9f9f9; border-bottom: 1px solid #bbb; align-items: center; padding: 0 15px; justify-content: space-between; }
        .back-btn { color: var(--primary-red); font-weight: bold; background: none; border: none; font-size: 16px; }

        .editor-container { flex: 1; overflow-y: auto; padding: 30px 15px; display: flex; justify-content: center; }

        /* --- çº¸å¼ æ ·å¼ & å°é¢ä¼˜åŒ– --- */
        #capture-node, .paper { 
            width: 100%; max-width: 500px; min-height: 700px; height: fit-content;
            background: #fff; box-shadow: 0 10px 40px rgba(0,0,0,0.1); 
            position: relative; color: #333; transition: 0.3s;
            display: flex; flex-direction: column;
        }
        
        /* å°é¢åŒºåŸŸ (Art Header) */
        .art-header { padding: 60px 45px 30px 45px; border-bottom: 1px solid rgba(0,0,0,0.05); margin-bottom: 30px; }
        .art-title { font-size: 30px; font-weight: 900; line-height: 1.3; letter-spacing: -1px; margin-bottom: 18px; word-break: break-all; }
        .art-author { font-size: 12px; display: flex; align-items: center; gap: 10px; text-transform: uppercase; letter-spacing: 2.5px; color: #888; font-weight: 600; }
        .art-author::before { content: ''; width: 30px; height: 1px; background: #ccc; }

        .paper-body { padding: 0 45px 60px 45px; flex: 1; }
        .art-content p { margin: 0 0 24px 0; font-size: 18px; line-height: 1.8; text-align: justify; }

        .input-title { width: 100%; border: none; outline: none; background: transparent; font-size: 26px; font-weight: 900; margin-bottom: 15px; font-family: inherit; }
        .input-content { 
            width: 100%; border: none; outline: none; background: transparent; 
            font-size: 18px; line-height: 1.8; resize: none; min-height: 600px; 
            font-family: inherit; 
            /* è§£å†³å®‹ä½“å¼•å·é‡å çš„å…³é”® CSS */
            letter-spacing: 0.03em; 
            text-rendering: optimizeLegibility;
        }
        
        .art-footer {
            margin-top: auto; padding: 40px 0; text-align: center;
            opacity: 0.2; font-size: 11px; letter-spacing: 4px;
            text-transform: uppercase; font-weight: 700;
        }

        /* --- ä¸»é¢˜ç³»ç»Ÿ --- */
        #capture-node.theme-white, .theme-white { background: #fff !important; color: #1f2937; }
        
        #capture-node.theme-grid, .theme-grid { 
            background-color: #f9fbfd !important; 
            background-image: url("data:image/svg+xml,%3Csvg width='24' height='24' viewBox='0 0 24 24' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M24 0v24H0' stroke='%23000' stroke-opacity='0.04' stroke-width='0.5' fill='none'/%3E%3C/svg%3E") !important; 
        }
        
        #capture-node.theme-retro, .theme-retro { 
            background-color: #fdf6e3 !important; color: #5c4b37; 
            background-image: url("data:image/svg+xml,%3Csvg width='20' height='20' viewBox='0 0 20 20' xmlns='http://www.w3.org/2000/svg'%3E%3Ccircle cx='2' cy='2' r='1' fill='%23d6ceaa' fill-opacity='0.6'/%3E%3C/svg%3E") !important; 
        }
        
        #capture-node.theme-dark, .theme-dark { 
            background-color: #191919 !important; color: #b0b0b0 !important; 
            background-image: url("data:image/svg+xml,%3Csvg width='100%25' height='30' viewBox='0 0 100 30' preserveAspectRatio='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cline x1='0' y1='29' x2='100' y2='29' stroke='white' stroke-opacity='0.04' stroke-width='1'/%3E%3C/svg%3E") !important;
            background-size: 100% 30px !important;
        }
        .theme-dark .art-header { border-bottom-color: #333; }
        .theme-dark .art-title { color: #eee; }

        /* å­—ä½“ç³»ç»Ÿ */
        .font-sans { font-family: "PingFang SC", sans-serif; }
        .font-serif { font-family: 'Noto Serif SC', serif; font-weight: 400; }

        /* --- å·¥å…·æ  --- */
        .toolbar { position: absolute; bottom: 30px; right: 30px; display: flex; flex-direction: column; gap: 12px; z-index: 100; }
        .fab { width: 52px; height: 52px; border-radius: 50%; background: #fff; border: none; box-shadow: 0 4px 15px rgba(0,0,0,0.2); cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 20px; }
        .fab.primary { background: var(--primary-red); color: #fff; }

        .style-card { background: #fff; padding: 18px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); width: 230px; margin-bottom: 10px; }
        .style-label { font-size: 11px; color: #999; margin-bottom: 8px; display: block; font-weight: bold; }
        .dot-row { display: flex; gap: 8px; margin-bottom: 15px; }
        .dot { flex: 1; height: 32px; border-radius: 4px; border: 2px solid #eee; cursor: pointer; }
        .dot.active { border-color: var(--primary-red); }

        /* --- æ‰‹æœºç«¯é€‚é… --- */
        @media (max-width: 768px) {
            .sidebar { width: 100%; position: fixed; inset: 0; }
            .main-area { position: fixed; inset: 0; transform: translateX(100%); transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
            #app.mobile-active .main-area { transform: translateX(0); }
            .mobile-nav { display: flex; }
            .editor-container { padding: 0; background: #fff; }
            .paper { max-width: none; box-shadow: none; min-height: 100%; }
            .paper-body { padding: 30px 25px 100px 25px; }
        }

        .mask { position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 3000; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; gap: 15px; }
        #staging-area { position: absolute; left: -9999px; width: 500px; }
    </style>
</head>
<body>

<div id="app" :class="{'mobile-active': isMobileShow}">
    <!-- ç™»å½•ç•Œé¢ -->
    <div class="auth-mask" v-if="!user">
        <div class="auth-card">
            <div class="auth-header"><h3>Smartisan Notes Pro</h3></div>
            <div class="auth-body">
                <input class="auth-input" v-model="auth.u" placeholder="ç”¨æˆ·å">
                <input class="auth-input" type="password" v-model="auth.p" placeholder="å¯†ç ">
                <button class="auth-btn" @click="handleAuth">{{ isReg ? 'ç«‹å³æ³¨å†Œ' : 'ç™»å½•' }}</button>
                <div style="text-align:center; font-size:12px; margin-top:15px; color:#666; cursor:pointer;" @click="isReg=!isReg">
                    {{ isReg ? 'è¿”å›ç™»å½•' : 'æ²¡æœ‰è´¦å·ï¼Ÿå»æ³¨å†Œ' }}
                </div>
            </div>
        </div>
    </div>

    <!-- åŠ è½½ä¸­ -->
    <div class="mask" v-if="loading || generating">
        <div style="font-size:32px;">{{ generating ? 'âœ¨' : 'â˜ï¸' }}</div>
        <div>{{ generating ? 'æ­£åœ¨æ™ºèƒ½åˆ‡åˆ†å¹¶æ’ç‰ˆ...' : 'åŒæ­¥äº‘ç«¯æ•°æ®...' }}</div>
    </div>

    <!-- ä¾§è¾¹æ  -->
    <div class="sidebar">
        <div class="sidebar-header">
            <h2>æˆ‘çš„ä¾¿ç­¾</h2>
            <button @click="createNote" style="background:var(--primary-red); color:white; border:none; padding:5px 15px; border-radius:4px; font-weight:bold;">+ æ–°å»º</button>
        </div>
        <div class="note-list">
            <div class="note-item" v-for="n in notes" :key="n.id" :class="{active: currentNote && currentNote.id==n.id}" @click="openNote(n)">
                <div class="title">{{ n.attributes.title || 'æ— æ ‡é¢˜' }}</div>
                <div class="summary">{{ n.attributes.content || 'æš‚æ— å†…å®¹...' }}</div>
            </div>
        </div>
        <button @click="logout" style="padding:15px; background:none; border:none; color:#555; font-size:12px;">é€€å‡ºå½“å‰è´¦å·</button>
    </div>

    <!-- ç¼–è¾‘åŒº -->
    <div class="main-area" v-if="currentNote">
        <div class="mobile-nav">
            <button class="back-btn" @click="isMobileShow=false">â€¹ åˆ—è¡¨</button>
            <span style="font-size:12px; color:#999">{{ saving ? 'åŒæ­¥ä¸­...' : 'å·²åŠ å¯†ä¿å­˜' }}</span>
            <div style="width:40px"></div>
        </div>

        <div class="editor-container">
            <div class="paper" :class="[currentNote.attributes.theme || 'theme-white', currentNote.attributes.font || 'font-sans']">
                <div class="paper-body">
                    <input class="input-title" v-model="currentNote.attributes.title" @input="doSave" placeholder="è¾“å…¥æ ‡é¢˜">
                    <textarea ref="editor" class="input-content" v-model="currentNote.attributes.content" @input="onInput" placeholder="ç‚¹å‡»å¼€å§‹å†™ä½œ..."></textarea>
                </div>
            </div>
        </div>

        <div class="toolbar">
            <div class="style-card" v-if="showStyle">
                <span class="style-label">ä¿¡çº¸ä¸»é¢˜</span>
                <div class="dot-row">
                    <div class="dot theme-white" @click="updateAttr('theme','theme-white')" :class="{active: currentNote.attributes.theme=='theme-white'}"></div>
                    <div class="dot theme-grid" @click="updateAttr('theme','theme-grid')" :class="{active: currentNote.attributes.theme=='theme-grid'}"></div>
                    <div class="dot theme-retro" @click="updateAttr('theme','theme-retro')" :class="{active: currentNote.attributes.theme=='theme-retro'}"></div>
                    <div class="dot theme-dark" @click="updateAttr('theme','theme-dark')" :class="{active: currentNote.attributes.theme=='theme-dark'}"></div>
                </div>
                <span class="style-label">æ­£æ–‡å­—ä½“</span>
                <select v-model="currentNote.attributes.font" @change="doSave" style="width:100%; padding:6px; border-radius:4px; border:1px solid #ddd; margin-bottom:15px;">
                    <option value="font-sans">æ ‡å‡†é»‘ä½“ (ç°ä»£)</option>
                    <option value="font-serif">Noto å®‹ä½“ (æ–‡å­¦)</option>
                </select>
                <span class="style-label">åˆ‡åˆ†æ•°é‡ (é•¿å›¾åˆ†æ®µ)</span>
                <select v-model="splitCount" style="width:100%; padding:6px; border-radius:4px; border:1px solid #ddd;">
                    <option :value="1">ä¸åˆ‡åˆ† (å•å¼ é•¿å›¾)</option>
                    <option :value="2">æ™ºèƒ½åˆ‡åˆ† 2 å¼ </option>
                    <option :value="3">æ™ºèƒ½åˆ‡åˆ† 3 å¼ </option>
                    <option :value="4">æ™ºèƒ½åˆ‡åˆ† 4 å¼ </option>
                </select>
            </div>
            <button class="fab" @click="showStyle=!showStyle">ğŸ¨</button>
            <button class="fab" @click="deleteNote" style="color:var(--primary-red)">ğŸ—‘ï¸</button>
            <button class="fab primary" @click="exportImages">âœ¨</button>
        </div>
    </div>

    <!-- ç¦»å±æ¸²æŸ“åŒº (ç§»æ¤è‡ªæ‚¨çš„å·¥å…·) -->
    <div id="staging-area"></div>
</div>

<script>
const { createApp, ref, onMounted, nextTick } = Vue;

const CONFIG = {
    appId: 'E1rPatvQJfGDx7FnsXpGTHN1-gzGzoHsz',
    appKey: 'eqfKH55tCL5dh3oWqF0KkomM',
    serverURL: 'https://e1rpatvq.lc-cn-n1-shared.com'
};

createApp({
    setup() {
        const user = ref(null);
        const isReg = ref(false);
        const auth = ref({ u: '', p: '' });
        const notes = ref([]);
        const currentNote = ref(null);
        const isMobileShow = ref(false);
        const loading = ref(false);
        const saving = ref(false);
        const generating = ref(false);
        const showStyle = ref(false);
        const splitCount = ref(1);
        const editor = ref(null);
        let saveTimer = null;

        onMounted(() => {
            AV.init(CONFIG);
            user.value = AV.User.current();
            if (user.value) loadNotes();
        });

        const handleAuth = async () => {
            if (!auth.value.u || !auth.value.p) return alert("ä¿¡æ¯ä¸å®Œæ•´");
            loading.value = true;
            try {
                if (isReg.value) {
                    const u = new AV.User();
                    u.setUsername(auth.value.u); u.setPassword(auth.value.p);
                    user.value = await u.signUp();
                } else {
                    user.value = await AV.User.logIn(auth.value.u, auth.value.p);
                }
                loadNotes();
            } catch (e) { alert(e.message); }
            finally { loading.value = false; }
        };

        const loadNotes = async () => {
            loading.value = true;
            try {
                const q = new AV.Query('Note');
                q.descending('updatedAt');
                notes.value = await q.find();
                if (window.innerWidth > 768 && notes.value.length > 0) openNote(notes.value[0]);
            } finally { loading.value = false; }
        };

        const createNote = async () => {
            loading.value = true;
            try {
                const Note = AV.Object.extend('Note');
                const n = new Note();
                n.set('title', ''); n.set('content', ''); n.set('theme', 'theme-white'); n.set('font', 'font-sans');
                const acl = new AV.ACL();
                acl.setReadAccess(user.value, true); acl.setWriteAccess(user.value, true);
                n.setACL(acl);
                const saved = await n.save();
                notes.value.unshift(saved);
                openNote(saved);
            } finally { loading.value = false; }
        };

        const openNote = (n) => {
            currentNote.value = n;
            isMobileShow.value = true;
            nextTick(autoHeight);
        };

        const onInput = () => { autoHeight(); doSave(); };
        const autoHeight = () => {
            if (editor.value) {
                editor.value.style.height = 'auto';
                editor.value.style.height = editor.value.scrollHeight + 'px';
            }
        };

        const doSave = () => {
            if (saveTimer) clearTimeout(saveTimer);
            saveTimer = setTimeout(async () => {
                saving.value = true;
                try { await currentNote.value.save(); } 
                finally { saving.value = false; }
            }, 1000);
        };

        const updateAttr = (k, v) => {
            currentNote.value.set(k, v);
            doSave();
        };

        const deleteNote = async () => {
            if (!confirm("ç¡®å®šè¦åˆ é™¤å—ï¼Ÿ")) return;
            const id = currentNote.value.id;
            try {
                await currentNote.value.destroy();
                notes.value = notes.value.filter(n => n.id !== id);
                currentNote.value = null;
                isMobileShow.value = false;
            } catch (e) { alert("åˆ é™¤å¤±è´¥"); }
        };

        // --- âœ¨ æ ¸å¿ƒç§»æ¤ï¼šæ™ºèƒ½åˆ†å›¾å¯¼å‡ºé€»è¾‘ âœ¨ ---
        const exportImages = async () => {
            const count = parseInt(splitCount.value);
            const title = currentNote.value.attributes.title || 'æ— æ ‡é¢˜';
            const author = user.value.getUsername();
            const content = currentNote.value.attributes.content || '';
            const theme = currentNote.value.attributes.theme || 'theme-white';
            const font = currentNote.value.attributes.font || 'font-sans';
            
            // æŒ‰æ®µè½åˆ‡åˆ†
            const paragraphs = content.split('\n').filter(p => p.trim() !== '' || p === '');
            const pPerPage = Math.ceil(paragraphs.length / count);
            
            generating.value = true;
            showStyle.value = false;
            const staging = document.getElementById('staging-area');
            staging.innerHTML = '';

            try {
                let currentPIndex = 0;
                for (let i = 0; i < count; i++) {
                    // åˆ›å»ºä¸€ä¸ªè™šæ‹Ÿçº¸å¼ èŠ‚ç‚¹
                    const pageNode = document.createElement('div');
                    pageNode.id = "capture-node"; // å¤ç”¨ ID ç¡®ä¿æ ·å¼ä¼˜å…ˆçº§
                    pageNode.className = `${theme} ${font}`;
                    
                    let innerHTML = '';
                    // 1. åªæœ‰ç¬¬ä¸€é¡µæ¸²æŸ“å°é¢å¤´
                    if (i === 0) {
                        innerHTML += `
                            <div class="art-header">
                                <div class="art-title">${title}</div>
                                <div class="art-author">${author}</div>
                            </div>`;
                    } else {
                        // åç»­é¡µé¢é¡¶éƒ¨ç•™ç™½ï¼Œå¢åŠ å‘¼å¸æ„Ÿ
                        innerHTML += `<div style="height:60px"></div>`;
                    }

                    // 2. æ³¨å…¥å½“å‰é¡µåº”å¾—çš„æ®µè½
                    innerHTML += '<div class="paper-body art-content">';
                    const slice = paragraphs.slice(currentPIndex, currentPIndex + pPerPage);
                    slice.forEach(txt => {
                        const pTag = txt.trim() === '' ? '<br>' : `<p>${txt}</p>`;
                        innerHTML += pTag;
                    });
                    innerHTML += '</div>';

                    // 3. åªæœ‰æœ€åä¸€é¡µæ¸²æŸ“è„šæ³¨
                    if (i === count - 1) {
                        innerHTML += `<div class="art-footer">GENERATED BY SMARTISAN</div>`;
                    } else {
                        // éæœ€åä¸€é¡µåº•éƒ¨ç•™ç™½
                        innerHTML += `<div style="height:40px"></div>`;
                    }

                    pageNode.innerHTML = innerHTML;
                    staging.appendChild(pageNode);

                    // ç»™æ¸²æŸ“é¢„ç•™å¾®å°æ—¶é—´
                    await new Promise(r => setTimeout(r, 100));

                    // æ‰§è¡Œæˆªå›¾
                    const canvas = await html2canvas(pageNode, {
                        scale: 2.5, // é«˜æ¸…å€ç‡
                        useCORS: true,
                        backgroundColor: null
                    });

                    // ä¸‹è½½
                    const link = document.createElement('a');
                    link.download = `Note_${title}_Part${i + 1}.png`;
                    link.href = canvas.toDataURL("image/png");
                    link.click();

                    currentPIndex += pPerPage;
                    staging.removeChild(pageNode);
                }
            } catch (e) {
                alert("é•¿å›¾åˆ†æ®µå¯¼å‡ºå¤±è´¥: " + e.message);
            } finally {
                generating.value = false;
            }
        };

        const logout = () => { AV.User.logOut(); location.reload(); };

        return {
            user, isReg, auth, notes, currentNote, isMobileShow, loading, saving, generating, showStyle, splitCount, editor,
            handleAuth, createNote, openNote, onInput, updateAttr, doSave, deleteNote, exportImages, logout
        };
    }
}).mount('#app');
</script>
</body>
</html>