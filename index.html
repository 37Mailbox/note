<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Smartisan Cloud Lite</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://unpkg.com/leancloud-storage@4.15.0/dist/av-min.js"></script>
    
    <style>
        /* --- åŸºç¡€æ ·å¼ --- */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body, html { margin: 0; padding: 0; height: 100%; font-family: -apple-system, "PingFang SC", sans-serif; background: #3d3d3d; overflow: hidden; }
        #app { display: flex; height: 100vh; width: 100vw; position: relative; overflow: hidden; }
        
        /* --- ä¾§è¾¹æ  (åˆ—è¡¨) --- */
        .sidebar { 
            width: 300px; 
            background: #2d2d2d; 
            color: #bbb; 
            display: flex; 
            flex-direction: column; 
            border-right: 1px solid #222; 
            z-index: 10; 
            flex-shrink: 0; 
        }
        .sidebar-header { padding: 15px 20px; border-bottom: 1px solid #444; background: #2d2d2d; display: flex; justify-content: space-between; align-items: center; }
        .app-title { font-weight: 600; color: #eee; letter-spacing: 1px; }
        .new-btn { background: #d95e48; color: white; border: none; padding: 6px 14px; border-radius: 4px; cursor: pointer; font-size: 13px; font-weight: bold; }
        
        .note-list { flex: 1; overflow-y: auto; }
        .note-item { padding: 16px 20px; border-bottom: 1px solid #3a3a3a; cursor: pointer; transition: 0.2s; position: relative; }
        .note-item.active { background: #404040; }
        .note-item.active::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 4px; background: #d95e48; }
        
        .note-preview-title { color: #eee; font-size: 16px; font-weight: bold; margin-bottom: 6px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        /* æ–°å¢ï¼šæ­£æ–‡é¢„è§ˆæ ·å¼ */
        .note-preview-content { font-size: 13px; color: #888; margin-bottom: 8px; line-height: 1.4; height: 36px; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; text-overflow: ellipsis; }
        .note-preview-date { font-size: 12px; color: #555; display: flex; justify-content: space-between;}
        
        /* --- ä¸»ç¼–è¾‘åŒºåŸŸ --- */
        .main-area { flex: 1; background: #e0e0e0; display: flex; flex-direction: column; position: relative; overflow: hidden; transition: transform 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94); }
        
        .mobile-nav { width: 100%; height: 50px; background: #f8f8f8; border-bottom: 1px solid #ddd; display: none; align-items: center; padding: 0 15px; z-index: 50; justify-content: space-between; flex-shrink: 0; }
        .back-btn { border: none; background: transparent; color: #555; font-weight: 600; font-size: 15px; cursor: pointer; display: flex; align-items: center; }
        .save-status { font-size: 12px; color: #999; transition: color 0.3s; }
        .save-status.saving { color: #d95e48; }

        /* ç¼–è¾‘å™¨å®¹å™¨ */
        .editor-wrapper { flex: 1; width: 100%; display: flex; justify-content: center; overflow-y: auto; overflow-x: hidden; padding: 30px 0 100px 0; -webkit-overflow-scrolling: touch; }
        .paper-sheet { width: 100%; max-width: 600px; min-height: 800px; height: fit-content; box-shadow: 0 10px 30px rgba(0,0,0,0.15); display: flex; flex-direction: column; position: relative; transition: background 0.3s; border-radius: 4px; background: white; }
        
        .paper-header { padding: 35px 40px 10px 40px; flex-shrink: 0; }
        .input-title { width: 100%; border: none; background: transparent; outline: none; font-size: 24px; font-weight: bold; padding-bottom: 15px; border-bottom: 1px solid rgba(0,0,0,0.05); color: inherit; }
        .input-author { width: 100%; border: none; background: transparent; outline: none; font-size: 14px; opacity: 0.6; margin-top: 10px; color: inherit; letter-spacing: 1px; }
        .paper-body { flex: 1; padding: 10px 40px 50px 40px; cursor: text; display: flex; flex-direction: column; }
        .input-content { width: 100%; border: none; background: transparent; outline: none; resize: none; font-size: 18px; line-height: 1.8; color: inherit; font-family: inherit; overflow: hidden; min-height: 400px; padding-bottom: 150px; }

        /* å·¥å…·æ  */
        .toolbar-dock { position: absolute; bottom: 30px; right: 30px; display: flex; flex-direction: column; align-items: flex-end; gap: 12px; z-index: 100; pointer-events: none; }
        .toolbar-dock > * { pointer-events: auto; } /* è®©æŒ‰é’®å¯ç‚¹å‡» */
        .tool-row { display: flex; gap: 15px; }
        .fab { width: 50px; height: 50px; border-radius: 50%; border: none; background: white; color: #555; box-shadow: 0 4px 12px rgba(0,0,0,0.15); font-size: 20px; cursor: pointer; display: flex; justify-content: center; align-items: center; transition: 0.2s; }
        .fab:hover { transform: scale(1.08); background: #fcfcfc; }
        .fab.primary { background: #d95e48; color: white; }
        
        /* æ ·å¼é¢æ¿ */
        .style-panel { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.2); margin-bottom: 10px; width: 240px; }
        .panel-row { margin-bottom: 12px; }
        .panel-label { font-size: 12px; color: #888; margin-bottom: 6px; display: block; font-weight: bold; }
        .theme-grid { display: flex; gap: 8px; }
        .theme-opt { flex: 1; height: 36px; border-radius: 6px; border: 1px solid #eee; cursor: pointer; position: relative; }
        .theme-opt.active { border: 2px solid #d95e48; }
        .select-box { width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px; }

        /* ä¸»é¢˜å®šä¹‰ */
        .theme-white { background-color: #ffffff; color: #333; }
        .theme-grid { background-color: #f7f9fc; color: #2c3e50; background-image: linear-gradient(#e6e9ef 1px, transparent 1px), linear-gradient(90deg, #e6e9ef 1px, transparent 1px); background-size: 30px 30px; background-attachment: local; }
        .theme-retro { background-color: #fdf6e3; color: #5c4b37; background-image: radial-gradient(#d6ceaa 1px, transparent 1px); background-size: 20px 20px; background-attachment: local; }
        .theme-dark { background-color: #222; color: #ccc; background-image: linear-gradient(#333 1px, transparent 1px); background-size: 100% 30px; background-attachment: local; }
        .theme-dark .input-title { border-bottom-color: #444; }

        .font-sans { font-family: -apple-system, "PingFang SC", sans-serif; }
        .font-serif { font-family: "Songti SC", "Noto Serif SC", serif; letter-spacing: 0.5px; }
        .font-kai { font-family: "Kaiti SC", "KaiTi", serif; }
        .font-round { font-family: "YouYuan", "Varela Round", sans-serif; }

        #staging-area { position: fixed; left: 200%; top: 0; width: 600px; pointer-events: none; opacity: 0; }
        .loading-mask { position: fixed; inset: 0; background: rgba(0,0,0,0.85); color: white; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 999; }
        
        /* --- ğŸ“± é‡ç‚¹ï¼šæ‰‹æœºç«¯é€‚é… --- */
        @media (max-width: 768px) {
            #app {
                width: 100vw;
                height: 100vh;
                position: relative;
            }

            /* åˆ—è¡¨é»˜è®¤å æ»¡å…¨å± */
            .sidebar { 
                width: 100%; 
                position: absolute; 
                top: 0; 
                left: 0; 
                height: 100%; 
                z-index: 10;
                transform: translateX(0);
                transition: transform 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
            }

            /* ç¼–è¾‘åŒºé»˜è®¤åœ¨å±å¹•å³ä¾§ä¹‹å¤– */
            .main-area { 
                width: 100%; 
                position: absolute; 
                top: 0; 
                left: 0;
                height: 100%; 
                z-index: 20;
                transform: translateX(100%);
                box-shadow: -5px 0 20px rgba(0,0,0,0.1);
            }

            .mobile-nav { display: flex; } /* æ˜¾ç¤ºæ‰‹æœºé¡¶éƒ¨å¯¼èˆª */
            .editor-wrapper { padding: 0; background: #f0f0f0; }
            .paper-sheet { 
                box-shadow: none; 
                border-radius: 0; 
                width: 100%; 
                max-width: none; 
                min-height: calc(100vh - 50px); 
                padding-bottom: 80px;
            }
            .paper-header { padding: 25px 20px 10px 20px; }
            .paper-body { padding: 10px 20px 80px 20px; }

            /* è§†å›¾åˆ‡æ¢é€»è¾‘ */
            /* æ˜¾ç¤ºç¼–è¾‘å™¨æ—¶ï¼šåˆ—è¡¨ä¸åŠ¨ï¼ˆæˆ–è€…ç¨å¾®è§†å·®ï¼‰ï¼Œç¼–è¾‘å™¨æ»‘è¿›æ¥ */
            .show-editor .sidebar { transform: translateX(-20%); opacity: 0.8; }
            .show-editor .main-area { transform: translateX(0); }
            
            /* æ˜¾ç¤ºåˆ—è¡¨æ—¶ï¼šç¼–è¾‘å™¨æ»‘å‡ºå» */
            .show-list .sidebar { transform: translateX(0); opacity: 1; }
            .show-list .main-area { transform: translateX(100%); }
        }
    </style>
</head>
<body>

<div id="app" :class="viewModeClass">
    <div class="loading-mask" v-if="isLoading || isGenerating">
        <div style="font-size: 30px; margin-bottom: 20px;">
            {{ isGenerating ? 'âœ¨' : 'â˜ï¸' }}
        </div>
        <h3>{{ isGenerating ? 'æ­£åœ¨ç”Ÿæˆé•¿å›¾...' : 'æ­£åœ¨åŒæ­¥äº‘ç«¯...' }}</h3>
        <p style="margin-top: 10px; opacity: 0.7; font-size: 14px;">{{ statusMsg }}</p>
    </div>

    <!-- ä¾§è¾¹æ  (åˆ—è¡¨) -->
    <div class="sidebar">
        <div class="sidebar-header">
            <span class="app-title">ğŸ“ äº‘ç«¯ä¾¿ç­¾</span>
            <button class="new-btn" @click="createCloudNote">æ–°å»º</button>
        </div>
        <div class="note-list">
            <div class="note-item" v-for="note in notes" :key="note.id" 
                 :class="{ active: currentNote && currentNote.id === note.id }"
                 @click="selectNote(note)">
                <div class="note-preview-title">{{ note.attributes.title || 'æ— æ ‡é¢˜' }}</div>
                <!-- âœ¨ æ–°å¢ï¼šæ–‡ç« å†…å®¹é¢„è§ˆ âœ¨ -->
                <div class="note-preview-content">{{ getSummary(note) }}</div>
                
                <div class="note-preview-date">
                    <span>{{ formatTime(note.updatedAt) }}</span>
                    <span v-if="!note.hasPendingChanges">â˜ï¸</span>
                    <span v-else>ğŸ•’</span>
                </div>
            </div>
            <!-- ç©ºçŠ¶æ€æç¤º -->
            <div v-if="notes.length === 0 && !isLoading" style="padding: 40px 20px; text-align: center; color: #666; font-size: 14px;">
                è¿˜æ²¡æœ‰ä¾¿ç­¾ï¼Œç‚¹å‡»å³ä¸Šè§’â€œæ–°å»ºâ€
            </div>
        </div>
    </div>

    <!-- ä¸»ç¼–è¾‘åŒº -->
    <div class="main-area">
        <div class="mobile-nav">
            <button class="back-btn" @click="backToList">
                <span style="font-size: 18px; margin-right: 4px;">â€¹</span> è¿”å›
            </button>
            <span class="save-status" :class="{ saving: isSaving }">
                {{ isSaving ? 'åŒæ­¥ä¸­...' : 'å·²åŒæ­¥' }}
            </span>
        </div>

        <div class="editor-wrapper" v-if="currentNote">
            <!-- ä¿®å¤äº†ä¸»é¢˜é»˜è®¤å€¼é—®é¢˜ï¼Œæ·»åŠ äº† theme-white -->
            <div class="paper-sheet" 
                 :class="[currentNote.attributes.theme || 'theme-white', currentNote.attributes.font || 'font-sans']"
                 @click="focusBody">
                <div class="paper-header">
                    <input class="input-title" v-model="currentNote.attributes.title" @input="triggerSave" placeholder="è¾“å…¥æ ‡é¢˜" maxlength="50">
                    <input class="input-author" v-model="currentNote.attributes.author" @input="triggerSave" placeholder="ä½œè€…ç½²å (å¯é€‰)">
                </div>
                <div class="paper-body">
                    <textarea ref="textareaRef" class="input-content" 
                        v-model="currentNote.attributes.content" @input="handleInput"
                        placeholder="ç‚¹å‡»æ­¤å¤„è¾“å…¥æ­£æ–‡..."></textarea>
                </div>
                <div style="text-align:center; padding: 20px; opacity:0.1; font-size:12px; letter-spacing:2px; font-weight:bold; pointer-events:none;">SMARTISAN NOTES</div>
            </div>
        </div>

        <div class="toolbar-dock" v-if="currentNote">
            <div class="style-panel" v-if="showStylePanel">
                <div class="panel-row">
                    <span class="panel-label">ä¿¡çº¸ä¸»é¢˜</span>
                    <div class="theme-grid">
                        <div class="theme-opt" style="background:#fff" @click="updateStyle('theme', 'theme-white')" :class="{active: (currentNote.attributes.theme || 'theme-white')=='theme-white'}"></div>
                        <div class="theme-opt" style="background:#f7f9fc" @click="updateStyle('theme', 'theme-grid')" :class="{active: currentNote.attributes.theme=='theme-grid'}"></div>
                        <div class="theme-opt" style="background:#fdf6e3" @click="updateStyle('theme', 'theme-retro')" :class="{active: currentNote.attributes.theme=='theme-retro'}"></div>
                        <div class="theme-opt" style="background:#333" @click="updateStyle('theme', 'theme-dark')" :class="{active: currentNote.attributes.theme=='theme-dark'}"></div>
                    </div>
                </div>
                <div class="panel-row">
                    <span class="panel-label">å­—ä½“é£æ ¼</span>
                    <select class="select-box" :value="currentNote.attributes.font || 'font-sans'" @change="e => updateStyle('font', e.target.value)">
                        <option value="font-sans">é»‘ä½“ (ç°ä»£)</option>
                        <option value="font-serif">å®‹ä½“ (äººæ–‡)</option>
                        <option value="font-kai">æ¥·ä½“ (æ‰‹å†™)</option>
                        <option value="font-round">åœ†ä½“ (å¯çˆ±)</option>
                    </select>
                </div>
                <div class="panel-row">
                    <span class="panel-label">ç”Ÿæˆåˆ‡åˆ†</span>
                    <select class="select-box" v-model="splitCount">
                        <option :value="1">ç”Ÿæˆ 1 å¼ é•¿å›¾</option>
                        <option :value="2">è‡ªåŠ¨åˆ‡åˆ† 2 å¼ </option>
                        <option :value="3">è‡ªåŠ¨åˆ‡åˆ† 3 å¼ </option>
                    </select>
                </div>
            </div>
            <div class="tool-row">
                <button class="fab danger" @click="deleteCloudNote">ğŸ—‘ï¸</button>
                <button class="fab" @click="showStylePanel = !showStylePanel">ğŸ¨</button>
                <button class="fab primary" @click="generateImage">âœ¨</button>
            </div>
        </div>
    </div>
    <div id="staging-area"></div>
</div>

<script>
    const { createApp, ref, computed, nextTick, onMounted } = Vue;

    // --- â­ é…ç½®åŒºåŸŸï¼šè¯·æ›¿æ¢ä¸ºä½ è‡ªå·±çš„ LeanCloud å¯†é’¥ â­ ---
    const CONFIG = {
        appId: 'E1rPatvQJfGDx7FnsXpGTHN1-gzGzoHsz',       
        appKey: 'eqfKH55tCL5dh3oWqF0KkomM',     
        serverURL: 'https://e1rpatvq.lc-cn-n1-shared.com' 
    };

    createApp({
        setup() {
            // State
            const notes = ref([]);
            const currentNote = ref(null);
            const showStylePanel = ref(false);
            const isGenerating = ref(false);
            const isLoading = ref(false);
            const isSaving = ref(false); 
            const statusMsg = ref('');
            const splitCount = ref(1);
            const textareaRef = ref(null);
            
            const isMobile = window.innerWidth <= 768;
            // æ‰‹æœºä¸Šé»˜è®¤åªæ˜¾ç¤ºåˆ—è¡¨(list)ï¼Œç”µè„‘ä¸Šæ˜¾ç¤ºç¼–è¾‘å™¨(editor)
            const viewMode = ref(isMobile ? 'list' : 'editor');

            // Timer for Debounce
            let saveTimer = null;

            const initLeanCloud = () => {
                if (!AV.applicationId) {
                    AV.init({ appId: CONFIG.appId, appKey: CONFIG.appKey, serverURL: CONFIG.serverURL });
                }
            };

            const fetchNotes = async () => {
                isLoading.value = true;
                statusMsg.value = 'æ­£åœ¨æ‹‰å–...';
                try {
                    const query = new AV.Query('Note');
                    query.descending('updatedAt');
                    notes.value = await query.find();
                    
                    // ç”µè„‘ç«¯é»˜è®¤é€‰ä¸­ç¬¬ä¸€æ¡ï¼Œæ‰‹æœºç«¯åœç•™åœ¨åˆ—è¡¨
                    if (notes.value.length > 0 && !isMobile) {
                        selectNote(notes.value[0]);
                    }
                } catch (error) {
                    console.error(error);
                } finally {
                    isLoading.value = false;
                }
            };

            // --- æ–°å»ºç¬”è®°ï¼ˆä¿®æ”¹ç‰ˆï¼šå¢åŠ  ACL è®¾ç½®ï¼‰---
            const createCloudNote = async () => {
                isLoading.value = true;
                statusMsg.value = 'æ­£åœ¨åˆ›å»º...';
                try {
                    const Note = AV.Object.extend('Note');
                    const note = new Note();
                    note.set('title', '');
                    note.set('content', '');
                    note.set('author', '');
                    note.set('theme', 'theme-white');
                    note.set('font', 'font-sans');
                    
                    // ğŸ”¥ å…³é”®ä¿®æ”¹ï¼šè®¾ç½® ACL ä¸ºæ‰€æœ‰äººå¯è¯»ã€å¯å†™ ğŸ”¥
                    // è¿™æ ·å³ä½¿ä½ æ˜¯åŒ¿åç”¨æˆ·ï¼Œä¹Ÿèƒ½åˆ é™¤è‡ªå·±åˆšæ‰å»ºçš„ï¼Œæˆ–è€…ä»¥åå»ºçš„
                    const acl = new AV.ACL();
                    acl.setPublicReadAccess(true);
                    acl.setPublicWriteAccess(true);
                    note.setACL(acl);
                    
                    const savedNote = await note.save();
                    notes.value.unshift(savedNote); 
                    
                    // æ–°å»ºåç›´æ¥è¿›å…¥ç¼–è¾‘
                    selectNote(savedNote);
                } catch (e) {
                    alert('åˆ›å»ºå¤±è´¥: ' + e.message);
                } finally {
                    isLoading.value = false;
                }
            };


            // --- æ›¿æ¢åŸæœ‰çš„ deleteCloudNote å‡½æ•° ---

// --- åˆ é™¤ç¬”è®°ï¼ˆä¿®æ”¹ç‰ˆï¼šæš´åŠ›åˆ é™¤ï¼‰---
            const deleteCloudNote = async () => {
                if(!confirm('ç¡®å®šæ°¸ä¹…åˆ é™¤è¿™æ¡äº‘ç«¯ä¾¿ç­¾å—ï¼Ÿ')) return;
                isLoading.value = true;
                statusMsg.value = 'æ­£åœ¨å¤„ç†...'; // æ”¹æ–‡æ¡ˆï¼Œå› ä¸ºå¯èƒ½åªæ˜¯æœ¬åœ°åˆ é™¤
                
                try {
                    // 1. å°è¯•ä»äº‘ç«¯åˆ é™¤
                    if (currentNote.value && currentNote.value.id) {
                        try {
                            await currentNote.value.destroy();
                        } catch (serverError) {
                            console.warn("äº‘ç«¯åˆ é™¤å¤±è´¥ï¼Œè½¬ä¸ºå¼ºåˆ¶æœ¬åœ°åˆ é™¤:", serverError);
                            // å¦‚æœæ˜¯æƒé™é”™è¯¯(403)æˆ–è€…æ‰¾ä¸åˆ°å¯¹è±¡(404)ï¼Œæˆ‘ä»¬å¯ä»¥å¿½ç•¥ï¼Œç›´æ¥åˆ æœ¬åœ°
                            // è¿™æ ·ç”¨æˆ·ä½“éªŒæœ€å¥½ï¼Œä¸ä¼šå¡æ­»
                        }
                    }

                    // 2. æ— è®ºäº‘ç«¯æ˜¯å¦æˆåŠŸï¼Œéƒ½ä»æœ¬åœ°åˆ—è¡¨ç§»é™¤
                    const idx = notes.value.findIndex(n => n.id === currentNote.value.id);
                    if(idx > -1) notes.value.splice(idx, 1);
                    
                    // 3. å¤„ç†åç»­è·³è½¬
                    if (isMobile) {
                        backToList();
                    } else {
                        if(notes.value.length > 0) selectNote(notes.value[0]);
                        else await createCloudNote();
                    }
                } catch (e) {
                    // åªæœ‰æå…¶ä¸¥é‡çš„é”™è¯¯ï¼ˆæ¯”å¦‚ä»£ç å´©äº†ï¼‰æ‰å¼¹çª—ï¼Œç½‘ç»œ/æƒé™é”™è¯¯ä¸Šé¢å·²ç»åæ‰äº†
                    alert('æœ¬åœ°å¤„ç†å‡ºé”™: ' + e.message);
                } finally {
                    isLoading.value = false;
                }
            };

            const triggerSave = () => {
                if (!currentNote.value) return;
                currentNote.value.hasPendingChanges = true;
                isSaving.value = true;
                if (saveTimer) clearTimeout(saveTimer);
                saveTimer = setTimeout(async () => {
                    try {
                        await currentNote.value.save();
                        currentNote.value.hasPendingChanges = false;
                    } catch (e) { console.error(e); } 
                    finally { isSaving.value = false; }
                }, 1500);
            };

            const handleInput = () => {
                autoResize();
                triggerSave();
            };
            
            const updateStyle = (key, val) => {
                if (currentNote.value) {
                    currentNote.value.set(key, val);
                    triggerSave(); 
                }
            };

            const selectNote = (note) => {
                currentNote.value = note;
                viewMode.value = 'editor'; // åˆ‡æ¢åˆ°ç¼–è¾‘è§†å›¾
                showStylePanel.value = false;
                nextTick(autoResize);
            };

            const backToList = () => { 
                // è¿”å›åˆ—è¡¨æ—¶å¦‚æœæ­£åœ¨è¾“å…¥ï¼Œå°è¯•ç«‹å³ä¿å­˜
                if (currentNote.value && currentNote.value.hasPendingChanges) {
                   currentNote.value.save(); 
                }
                viewMode.value = 'list'; 
                // æ”¶èµ·é”®ç›˜
                if (document.activeElement) document.activeElement.blur();
            };

            const autoResize = () => {
                const el = textareaRef.value;
                if (!el) return;
                el.style.height = 'auto';
                el.style.height = (el.scrollHeight) + 'px';
            };

            const focusBody = (e) => {
                if (e.target.tagName !== 'INPUT' && e.target.tagName !== 'TEXTAREA') {
                    if (textareaRef.value) textareaRef.value.focus();
                }
            };

            const formatTime = (dateObj) => {
                if (!dateObj) return '';
                const d = new Date(dateObj);
                const now = new Date();
                // å¦‚æœæ˜¯ä»Šå¤©çš„æ¶ˆæ¯ï¼Œåªæ˜¾ç¤ºæ—¶é—´
                if (d.toDateString() === now.toDateString()) {
                    return `${d.getHours()}:${String(d.getMinutes()).padStart(2,'0')}`;
                }
                return `${d.getMonth()+1}/${d.getDate()}`;
            };

            // è·å–é¢„è§ˆæ–‡å­—
            const getSummary = (note) => {
                const c = note.attributes.content;
                if (!c) return 'æ— æ­£æ–‡å†…å®¹';
                // æ›¿æ¢æ‰æ¢è¡Œç¬¦ï¼Œè®©é¢„è§ˆæ›´ç´§å‡‘
                return c.replace(/\n/g, ' ').substring(0, 60);
            };
            
            const viewModeClass = computed(() => {
                if (!isMobile) return '';
                // ç¡®ä¿ Vue èƒ½æ ¹æ® viewMode åˆ‡æ¢ class
                return viewMode.value === 'list' ? 'show-list' : 'show-editor';
            });

            const generateImage = async () => {
                if (!currentNote.value) return;
                isGenerating.value = true;
                showStylePanel.value = false;
                const staging = document.getElementById('staging-area');
                staging.innerHTML = '';

                // ä½¿ç”¨ä¿åº•å€¼ theme-white
                const { title, author, content } = currentNote.value.attributes;
                const theme = currentNote.value.attributes.theme || 'theme-white';
                const font = currentNote.value.attributes.font || 'font-sans';
                
                const paragraphs = (content || '').split('\n');
                const count = splitCount.value;
                const pPerPage = Math.ceil(Math.max(paragraphs.length, 1) / count);

                try {
                    for (let i = 0; i < count; i++) {
                        if (i > 0 && i * pPerPage >= paragraphs.length) break;
                        statusMsg.value = `æ­£åœ¨ç»˜åˆ¶ç¬¬ ${i + 1} / ${count} å¼ ...`;
                        
                        const page = document.createElement('div');
                        page.className = `paper-sheet ${theme} ${font}`;
                        page.style.cssText = `width: 600px; min-height: 800px; position: relative; padding-bottom: 50px; box-shadow: none; border-radius: 0; overflow: hidden;`;

                        let html = '';
                        if (i === 0) {
                            html += `<div class="paper-header"><div class="input-title" style="border-bottom-style:solid; margin-bottom:0">${title || 'æ— æ ‡é¢˜'}</div><div class="input-author">${author || ''}</div></div>`;
                        } else {
                            html += `<div style="height: 40px;"></div>`;
                        }
                        html += `<div class="paper-body" style="padding: 10px 40px;">`;
                        const slice = paragraphs.slice(i * pPerPage, (i * pPerPage) + pPerPage);
                        slice.forEach(p => {
                            const text = p.trim() === '' ? '<br>' : p;
                            html += `<p style="font-size: 20px; line-height: 2.0; margin-bottom: 20px; text-align: justify; white-space: pre-wrap; word-break: break-word;">${text}</p>`;
                        });
                        html += `</div>`;
                        if ((i * pPerPage) + slice.length >= paragraphs.length) {
                            html += `<div style="text-align:center; padding:30px; opacity:0.3; font-size:14px; letter-spacing:3px; font-weight:bold;">GENERATED BY SMARTISAN</div>`;
                        }
                        page.innerHTML = html;
                        staging.appendChild(page);
                        await new Promise(r => setTimeout(r, 200));

                        const canvas = await html2canvas(page, { scale: 2, useCORS: true, backgroundColor: null });
                        const link = document.createElement('a');
                        link.download = `CloudNote_${title||'Share'}_${i+1}.png`;
                        link.href = canvas.toDataURL("image/png");
                        link.click();
                    }
                } catch (e) { alert('ç”Ÿæˆå¤±è´¥: ' + e.message); } 
                finally { isGenerating.value = false; staging.innerHTML = ''; }
            };

            onMounted(() => {
                initLeanCloud();
                fetchNotes();
                window.addEventListener('resize', autoResize);
            });

            return {
                CONFIG, notes, currentNote, showStylePanel, isGenerating, isLoading, isSaving, statusMsg, splitCount, 
                viewModeClass, textareaRef,
                createCloudNote, selectNote, deleteCloudNote, backToList, generateImage, formatTime, 
                handleInput, triggerSave, updateStyle, focusBody, getSummary
            };
        }
    }).mount('#app');
</script>
</body>
</html>