<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Smartisan Cloud Lite</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://unpkg.com/leancloud-storage@4.15.0/dist/av-min.js"></script>
    
    <style>
        /* --- åŸºç¡€æ ·å¼ --- */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body, html { 
            margin: 0; padding: 0; height: 100%; width: 100%;
            font-family: -apple-system, "PingFang SC", "Helvetica Neue", sans-serif; 
            background: #2d2d2d; overflow: hidden; 
        }
        
        #app { 
            display: flex; 
            height: 100vh; 
            width: 100vw; 
            position: relative; 
            overflow: hidden; 
            background: #2d2d2d;
        }
        
        /* --- ä¾§è¾¹æ  (åˆ—è¡¨) --- */
        .sidebar { 
            width: 320px; 
            background: #2d2d2d; 
            display: flex; 
            flex-direction: column; 
            border-right: 1px solid #1a1a1a; 
            z-index: 10; 
            flex-shrink: 0;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .sidebar-header { 
            padding: 20px; 
            background: #2d2d2d; 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            border-bottom: 1px solid #3a3a3a;
        }
        .app-title { font-weight: 600; color: #eee; font-size: 18px; }
        .new-btn { 
            background: #d95e48; color: white; border: none; 
            padding: 6px 16px; border-radius: 6px; 
            cursor: pointer; font-size: 14px; font-weight: bold;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .note-list { flex: 1; overflow-y: auto; -webkit-overflow-scrolling: touch; }
        .note-item { 
            padding: 16px 20px; border-bottom: 1px solid #333; 
            cursor: pointer; transition: background 0.2s; position: relative; 
        }
        .note-item:active { background: #3a3a3a; }
        .note-item.active { background: #3d3d3d; }
        .note-item.active::before { 
            content: ''; position: absolute; left: 0; top: 0; bottom: 0; 
            width: 4px; background: #d95e48; 
        }
        
        .note-preview-title { color: #eee; font-size: 16px; font-weight: 600; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .note-preview-content { font-size: 13px; color: #888; line-height: 1.5; height: 38px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; margin-bottom: 4px; }
        .note-preview-date { font-size: 11px; color: #555; display: flex; justify-content: space-between; align-items: center;}

        /* --- ä¸»ç¼–è¾‘åŒºåŸŸ --- */
        .main-area { 
            flex: 1; 
            background: #e5e5e5; 
            display: flex; 
            flex-direction: column; 
            position: relative; 
            z-index: 20;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        /* æ‰‹æœºç«¯é¡¶éƒ¨å¯¼èˆª */
        .mobile-nav { 
            height: 54px; background: #fdfdfd; 
            border-bottom: 1px solid #d0d0d0; 
            display: none; align-items: center; 
            padding: 0 15px; justify-content: space-between; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        .back-btn { border: none; background: transparent; color: #d95e48; font-weight: 600; font-size: 16px; padding: 10px 5px; cursor: pointer; }
        .save-status { font-size: 12px; color: #aaa; }

        /* ç¼–è¾‘å™¨å†…éƒ¨ */
        .editor-wrapper { 
            flex: 1; overflow-y: auto; padding: 40px 20px; 
            display: flex; justify-content: center; 
            background: #e5e5e5;
        }
        .paper-sheet { 
            width: 100%; max-width: 700px; min-height: 100%; 
            background: white; border-radius: 2px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            display: flex; flex-direction: column;
        }
        .paper-header { padding: 40px 40px 20px 40px; }
        .input-title { width: 100%; border: none; outline: none; font-size: 26px; font-weight: bold; border-bottom: 1px solid #eee; padding-bottom: 15px; color: #222; }
        .input-author { width: 100%; border: none; outline: none; font-size: 14px; margin-top: 15px; color: #999; }
        .paper-body { padding: 0 40px 60px 40px; flex: 1; }
        .input-content { 
            width: 100%; border: none; outline: none; resize: none; 
            font-size: 18px; line-height: 1.8; color: #333; 
            min-height: 400px; font-family: inherit;
        }

        /* æµ®åŠ¨å·¥å…·æ  */
        .toolbar-dock { position: absolute; bottom: 30px; right: 30px; display: flex; flex-direction: column; gap: 15px; align-items: flex-end; z-index: 100; }
        .fab { width: 56px; height: 56px; border-radius: 28px; border: none; background: white; box-shadow: 0 4px 15px rgba(0,0,0,0.2); cursor: pointer; font-size: 22px; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
        .fab.primary { background: #d95e48; color: white; }
        .fab:active { transform: scale(0.9); }

        .style-panel { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); margin-bottom: 15px; width: 250px; }
        .panel-row { margin-bottom: 15px; }
        .panel-label { display: block; font-size: 12px; color: #999; margin-bottom: 8px; font-weight: bold; }
        .theme-grid { display: flex; gap: 10px; }
        .theme-opt { flex: 1; height: 35px; border-radius: 4px; border: 2px solid #eee; cursor: pointer; }
        .theme-opt.active { border-color: #d95e48; }

        /* ä¸»é¢˜æ ·å¼ */
        .theme-white { background: #fff !important; color: #333; }
        .theme-grid { background: #f7f9fc !important; background-image: linear-gradient(#e6e9ef 1px, transparent 1px), linear-gradient(90deg, #e6e9ef 1px, transparent 1px) !important; background-size: 30px 30px !important; }
        .theme-retro { background: #fdf6e3 !important; background-image: radial-gradient(#d6ceaa 1px, transparent 1px) !important; background-size: 20px 20px !important; color: #5c4b37; }
        .theme-dark { background: #222 !important; color: #ccc; }
        .theme-dark .input-title { border-bottom-color: #444; color: #eee; }
        .theme-dark .input-content { color: #ccc; }

        .font-sans { font-family: sans-serif; }
        .font-serif { font-family: "Noto Serif SC", serif; }
        .font-kai { font-family: "Kaiti SC", serif; }

        /* --- ğŸ“± é‡ç‚¹ï¼šç§»åŠ¨ç«¯é€‚é…é€»è¾‘ --- */
        @media (max-width: 768px) {
            .sidebar { width: 100%; position: absolute; left: 0; top: 0; bottom: 0; }
            .main-area { 
                position: fixed; left: 0; top: 0; width: 100%; height: 100%; 
                transform: translateX(100%); /* é»˜è®¤è—åœ¨å³ä¾§ */
            }
            
            /* çŠ¶æ€åˆ‡æ¢ */
            #app.show-editor .main-area { transform: translateX(0); }
            #app.show-editor .sidebar { transform: translateX(-20%); }

            .mobile-nav { display: flex; }
            .editor-wrapper { padding: 0; background: #fff; }
            .paper-sheet { max-width: none; box-shadow: none; border-radius: 0; }
            .paper-header { padding: 30px 20px 10px 20px; }
            .paper-body { padding: 0 20px 100px 20px; }
            .toolbar-dock { bottom: 20px; right: 20px; }
        }

        /* é®ç½©å±‚ */
        .loading-mask { position: fixed; inset: 0; background: rgba(0,0,0,0.7); color: #fff; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 1000; }
    </style>
</head>
<body>

<div id="app" :class="{ 'show-editor': viewMode === 'editor' }">
    <!-- å…¨å±€åŠ è½½æç¤º -->
    <div class="loading-mask" v-if="isLoading || isGenerating">
        <div style="font-size: 30px; margin-bottom: 10px;">{{ isGenerating ? 'âœ¨' : 'â˜ï¸' }}</div>
        <div>{{ isGenerating ? 'æ­£åœ¨ç”Ÿæˆç¾å›¾...' : 'åŒæ­¥ä¸­...' }}</div>
    </div>

    <!-- åˆ—è¡¨é¡µ -->
    <div class="sidebar">
        <div class="sidebar-header">
            <span class="app-title">äº‘ç«¯ä¾¿ç­¾</span>
            <button class="new-btn" @click="createCloudNote">+ æ–°å»º</button>
        </div>
        <div class="note-list">
            <div class="note-item" v-for="note in notes" :key="note.id" 
                 :class="{ active: currentNote && currentNote.id === note.id }"
                 @click="selectNote(note)">
                <div class="note-preview-title">{{ note.attributes.title || 'æ— æ ‡é¢˜' }}</div>
                <div class="note-preview-content">{{ note.attributes.content || 'æš‚æ— å†…å®¹...' }}</div>
                <div class="note-preview-date">
                    <span>{{ formatTime(note.updatedAt) }}</span>
                    <span>{{ note.hasPendingChanges ? 'ğŸ•’' : 'â˜ï¸' }}</span>
                </div>
            </div>
            <div v-if="notes.length === 0" style="color:#666; text-align:center; margin-top:50px; font-size:14px;">
                ç‚¹å‡»â€œæ–°å»ºâ€å¼€å¯ç¬¬ä¸€æ¡ä¾¿ç­¾
            </div>
        </div>
    </div>

    <!-- ç¼–è¾‘é¡µ -->
    <div class="main-area" v-if="currentNote">
        <div class="mobile-nav">
            <button class="back-btn" @click="viewMode = 'list'">â€¹ åˆ—è¡¨</button>
            <span class="save-status">{{ isSaving ? 'ä¿å­˜ä¸­...' : 'äº‘ç«¯å·²åŒæ­¥' }}</span>
            <div style="width: 40px"></div> <!-- å ä½ä¿æŒå¹³è¡¡ -->
        </div>

        <div class="editor-wrapper">
            <div class="paper-sheet" :class="[currentNote.attributes.theme || 'theme-white', currentNote.attributes.font || 'font-sans']">
                <div class="paper-header">
                    <input class="input-title" v-model="currentNote.attributes.title" @input="triggerSave" placeholder="æ ‡é¢˜">
                    <input class="input-author" v-model="currentNote.attributes.author" @input="triggerSave" placeholder="ç½²å (å¯é€‰)">
                </div>
                <div class="paper-body">
                    <textarea ref="editorRef" class="input-content" 
                        v-model="currentNote.attributes.content" 
                        @input="onInput"
                        placeholder="åœ¨æ­¤è¾“å…¥å†…å®¹..."></textarea>
                </div>
            </div>
        </div>

        <!-- å·¥å…·æ  -->
        <div class="toolbar-dock">
            <div class="style-panel" v-if="showStyle">
                <div class="panel-row">
                    <span class="panel-label">èƒŒæ™¯ä¸»é¢˜</span>
                    <div class="theme-grid">
                        <div class="theme-opt theme-white" @click="updateStyle('theme', 'theme-white')" :class="{active: currentNote.attributes.theme === 'theme-white'}"></div>
                        <div class="theme-opt theme-grid" @click="updateStyle('theme', 'theme-grid')" :class="{active: currentNote.attributes.theme === 'theme-grid'}"></div>
                        <div class="theme-opt theme-retro" @click="updateStyle('theme', 'theme-retro')" :class="{active: currentNote.attributes.theme === 'theme-retro'}"></div>
                    </div>
                </div>
                <div class="panel-row">
                    <span class="panel-label">å­—ä½“</span>
                    <select v-model="currentNote.attributes.font" @change="triggerSave" style="width:100%; padding:5px;">
                        <option value="font-sans">æ ‡å‡†é»‘ä½“</option>
                        <option value="font-serif">äººæ–‡å®‹ä½“</option>
                        <option value="font-kai">ç»å…¸æ¥·ä½“</option>
                    </select>
                </div>
            </div>
            <button class="fab" @click="showStyle = !showStyle">ğŸ¨</button>
            <button class="fab" @click="deleteNote" style="color: #d95e48;">ğŸ—‘ï¸</button>
            <button class="fab primary" @click="generateImage">âœ¨</button>
        </div>
    </div>
</div>

<script>
    const { createApp, ref, onMounted, nextTick } = Vue;

    // --- é…ç½® ---
    const CONFIG = {
        appId: 'E1rPatvQJfGDx7FnsXpGTHN1-gzGzoHsz',
        appKey: 'eqfKH55tCL5dh3oWqF0KkomM',
        serverURL: 'https://e1rpatvq.lc-cn-n1-shared.com'
    };

    createApp({
        setup() {
            const notes = ref([]);
            const currentNote = ref(null);
            const viewMode = ref('list'); // 'list' or 'editor'
            const isLoading = ref(false);
            const isSaving = ref(false);
            const isGenerating = ref(false);
            const showStyle = ref(false);
            const editorRef = ref(null);
            let saveTimer = null;

            const init = () => {
                AV.init(CONFIG);
                loadNotes();
            };

            const loadNotes = async () => {
                isLoading.value = true;
                try {
                    const query = new AV.Query('Note');
                    query.descending('updatedAt');
                    notes.value = await query.find();
                    // PCç«¯é»˜è®¤é€‰ç¬¬ä¸€ä¸ª
                    if (window.innerWidth > 768 && notes.value.length > 0) {
                        selectNote(notes.value[0]);
                    }
                } finally {
                    isLoading.value = false;
                }
            };

            const selectNote = (note) => {
                currentNote.value = note;
                viewMode.value = 'editor';
                showStyle.value = false;
                nextTick(autoResize);
            };

            const createCloudNote = async () => {
                isLoading.value = true;
                try {
                    const Note = AV.Object.extend('Note');
                    const note = new Note();
                    note.set('title', '');
                    note.set('content', '');
                    note.set('theme', 'theme-white');
                    
                    const acl = new AV.ACL();
                    acl.setPublicReadAccess(true);
                    acl.setPublicWriteAccess(true);
                    note.setACL(acl);

                    const saved = await note.save();
                    notes.value.unshift(saved);
                    selectNote(saved);
                } finally {
                    isLoading.value = false;
                }
            };

            const deleteNote = async () => {
                if (!confirm('ç¡®å®šåˆ é™¤æ­¤ä¾¿ç­¾å—ï¼Ÿ')) return;
                const idToDelete = currentNote.value.id;
                isLoading.value = true;
                try {
                    // äº‘ç«¯åˆ é™¤
                    await currentNote.value.destroy();
                    // æœ¬åœ°æ¸…ç†
                    notes.value = notes.value.filter(n => n.id !== idToDelete);
                    viewMode.value = 'list';
                    currentNote.value = null;
                } catch (e) {
                    // å³ä½¿äº‘ç«¯å¤±è´¥ï¼ˆæ¯”å¦‚å·²è¢«åˆ ï¼‰ï¼Œæœ¬åœ°ä¹Ÿç§»é™¤
                    notes.value = notes.value.filter(n => n.id !== idToDelete);
                    viewMode.value = 'list';
                } finally {
                    isLoading.value = false;
                }
            };

            const triggerSave = () => {
                if (!currentNote.value) return;
                currentNote.value.hasPendingChanges = true;
                if (saveTimer) clearTimeout(saveTimer);
                saveTimer = setTimeout(async () => {
                    isSaving.value = true;
                    try {
                        await currentNote.value.save();
                        currentNote.value.hasPendingChanges = false;
                    } finally {
                        isSaving.value = false;
                    }
                }, 1000);
            };

            const onInput = () => {
                autoResize();
                triggerSave();
            };

            const autoResize = () => {
                const el = editorRef.value;
                if (el) {
                    el.style.height = 'auto';
                    el.style.height = el.scrollHeight + 'px';
                }
            };

            const updateStyle = (key, val) => {
                currentNote.value.set(key, val);
                triggerSave();
            };

            const formatTime = (date) => {
                if (!date) return '';
                const d = new Date(date);
                return `${d.getMonth()+1}/${d.getDate()} ${d.getHours()}:${String(d.getMinutes()).padStart(2, '0')}`;
            };

            const generateImage = async () => {
                isGenerating.value = true;
                showStyle.value = false;
                try {
                    // ç®€å•å®ç°ï¼šå°†å½“å‰paper-sheetæˆªå±
                    const sheet = document.querySelector('.paper-sheet');
                    const canvas = await html2canvas(sheet, { scale: 2, useCORS: true });
                    const link = document.createElement('a');
                    link.download = `Note_${Date.now()}.png`;
                    link.href = canvas.toDataURL();
                    link.click();
                } catch (e) {
                    alert('ç”Ÿæˆå¤±è´¥');
                } finally {
                    isGenerating.value = false;
                }
            };

            onMounted(init);

            return {
                notes, currentNote, viewMode, isLoading, isSaving, isGenerating, showStyle, editorRef,
                selectNote, createCloudNote, deleteNote, onInput, triggerSave, updateStyle, formatTime, generateImage
            };
        }
    }).mount('#app');
</script>
</body>
</html>