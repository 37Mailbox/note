<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Smartisan Cloud - ä¸ªäººç‰ˆ</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://unpkg.com/leancloud-storage@4.15.0/dist/av-min.js"></script>
    
    <style>
        /* --- åŸºç¡€æ ·å¼ (ä¿ç•™åŸæœ‰çš„é”¤å­é£æ ¼) --- */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body, html { margin: 0; padding: 0; height: 100%; background: #3d3d3d; font-family: "PingFang SC", sans-serif; overflow: hidden; }
        #app { display: flex; height: 100vh; width: 100vw; position: relative; }

        /* --- ç™»å½•æ³¨å†Œç•Œé¢ --- */
        .auth-overlay {
            position: fixed; inset: 0; background: #3d3d3d; z-index: 2000;
            display: flex; align-items: center; justify-content: center; padding: 20px;
        }
        .auth-card {
            background: #f8f8f8; width: 100%; max-width: 360px; border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5); overflow: hidden;
        }
        .auth-header { background: #d95e48; padding: 30px; text-align: center; color: white; }
        .auth-body { padding: 30px; }
        .auth-input {
            width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #ddd;
            border-radius: 6px; outline: none; font-size: 16px;
        }
        .auth-btn {
            width: 100%; padding: 12px; background: #d95e48; color: white;
            border: none; border-radius: 6px; font-weight: bold; font-size: 16px; cursor: pointer;
        }
        .auth-switch { text-align: center; margin-top: 15px; font-size: 14px; color: #666; cursor: pointer; }

        /* --- ä¾§è¾¹æ åŠç”¨æˆ·æ  --- */
        .sidebar { width: 300px; background: #2d2d2d; display: flex; flex-direction: column; z-index: 10; flex-shrink: 0; }
        .user-bar { padding: 10px 20px; background: #252525; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #1a1a1a; }
        .user-info { color: #888; font-size: 12px; }
        .logout-btn { color: #d95e48; font-size: 12px; cursor: pointer; background: transparent; border: none; }
        
        .sidebar-header { padding: 20px; display: flex; justify-content: space-between; align-items: center; }
        .app-title { color: #eee; font-weight: 600; }
        .new-btn { background: #d95e48; color: white; border: none; padding: 6px 14px; border-radius: 4px; font-weight: bold; cursor: pointer; }

        .note-list { flex: 1; overflow-y: auto; -webkit-overflow-scrolling: touch; }
        .note-item { padding: 16px 20px; border-bottom: 1px solid #333; cursor: pointer; transition: 0.2s; position: relative; }
        .note-item.active { background: #404040; }
        .note-item.active::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 4px; background: #d95e48; }
        .note-preview-title { color: #eee; font-size: 15px; font-weight: bold; margin-bottom: 4px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .note-preview-content { color: #888; font-size: 12px; height: 34px; line-height: 1.4; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }

        /* --- ç¼–è¾‘åŒº --- */
        .main-area { flex: 1; background: #e0e0e0; display: flex; flex-direction: column; position: relative; overflow: hidden; z-index: 20; }
        .mobile-nav { display: none; height: 50px; background: #f8f8f8; border-bottom: 1px solid #ccc; align-items: center; padding: 0 15px; justify-content: space-between; flex-shrink: 0; }
        .back-btn { border: none; background: transparent; color: #d95e48; font-size: 16px; font-weight: bold; }

        .editor-wrapper { flex: 1; overflow-y: auto; padding: 30px 15px; display: flex; justify-content: center; }
        .paper-sheet { width: 100%; max-width: 640px; min-height: 800px; background: #fff; box-shadow: 0 10px 30px rgba(0,0,0,0.2); border-radius: 2px; position: relative; }
        .paper-header { padding: 40px 40px 10px 40px; }
        .input-title { width: 100%; border: none; outline: none; background: transparent; font-size: 24px; font-weight: bold; border-bottom: 1px solid rgba(0,0,0,0.05); padding-bottom: 10px; }
        .paper-body { padding: 10px 40px 60px 40px; }
        .input-content { width: 100%; border: none; outline: none; font-size: 18px; line-height: 1.8; resize: none; overflow: hidden; min-height: 500px; }

        /* ä¸»é¢˜ */
        .theme-white { background: #fff; color: #333; }
        .theme-grid { background-color: #f7f9fc; background-image: linear-gradient(#e6e9ef 1px, transparent 1px), linear-gradient(90deg, #e6e9ef 1px, transparent 1px); background-size: 30px 30px; }
        .theme-retro { background-color: #fdf6e3; background-image: radial-gradient(#d6ceaa 1px, transparent 1px); background-size: 20px 20px; color: #5c4b37; }

        /* å·¥å…·æ  */
        .toolbar-dock { position: absolute; bottom: 30px; right: 30px; display: flex; flex-direction: column; gap: 12px; align-items: flex-end; z-index: 100; }
        .fab { width: 50px; height: 50px; border-radius: 50%; background: #fff; border: none; box-shadow: 0 4px 12px rgba(0,0,0,0.2); cursor: pointer; font-size: 20px; display: flex; align-items: center; justify-content: center; }
        .fab.primary { background: #d95e48; color: #fff; }

        /* æ‰‹æœºç«¯é€‚é… */
        @media (max-width: 768px) {
            .sidebar { width: 100%; position: absolute; left: 0; top: 0; transition: 0.3s; }
            .main-area { width: 100%; position: absolute; left: 0; top: 0; height: 100%; transform: translateX(100%); transition: 0.3s; }
            #app.show-editor .sidebar { transform: translateX(-20%); opacity: 0.5; }
            #app.show-editor .main-area { transform: translateX(0); }
            .mobile-nav { display: flex; }
            .editor-wrapper { padding: 0; background: #fff; }
            .paper-sheet { max-width: none; box-shadow: none; border-radius: 0; }
        }

        .loading-mask { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 3000; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; }
        #staging { position: absolute; top: -9999px; width: 640px; }
    </style>
</head>
<body>

<div id="app" :class="{'show-editor': isEditingMobile}">
    
    <!-- 1. ç™»å½•/æ³¨å†Œç•Œé¢ -->
    <div class="auth-overlay" v-if="!currentUser">
        <div class="auth-card">
            <div class="auth-header">
                <h2>äº‘ç«¯ä¾¿ç­¾</h2>
                <p>{{ authMode === 'login' ? 'è¯·ç™»å½•ä»¥è®¿é—®ä¸ªäººä¾¿ç­¾' : 'æ³¨å†Œæ–°è´¦å·' }}</p>
            </div>
            <div class="auth-body">
                <input class="auth-input" v-model="authForm.username" placeholder="ç”¨æˆ·å">
                <input class="auth-input" type="password" v-model="authForm.password" placeholder="å¯†ç ">
                <button class="auth-btn" @click="handleAuth" :disabled="isLoading">
                    {{ isLoading ? 'å¤„ç†ä¸­...' : (authMode === 'login' ? 'ç«‹å³ç™»å½•' : 'ç¡®è®¤æ³¨å†Œ') }}
                </button>
                <div class="auth-switch" @click="authMode = (authMode === 'login' ? 'register' : 'login')">
                    {{ authMode === 'login' ? 'æ²¡æœ‰è´¦å·ï¼Ÿç‚¹å‡»æ³¨å†Œ' : 'å·²æœ‰è´¦å·ï¼Ÿç‚¹å‡»ç™»å½•' }}
                </div>
            </div>
        </div>
    </div>

    <!-- 2. å…¨å±€åŠ è½½é®ç½© -->
    <div class="loading-mask" v-if="isLoading || isGenerating">
        <div>{{ isGenerating ? 'âœ¨ æ­£åœ¨ç”Ÿæˆé•¿å›¾...' : 'â˜ï¸ æ­£åœ¨åŒæ­¥...' }}</div>
    </div>

    <!-- 3. ä¸»ç•Œé¢ (ä»…åœ¨ç™»å½•åæ˜¾ç¤º) -->
    <template v-if="currentUser">
        <!-- åˆ—è¡¨ -->
        <div class="sidebar">
            <div class="user-bar">
                <span class="user-info">ğŸ‘¤ {{ currentUser.getUsername() }}</span>
                <button class="logout-btn" @click="logout">é€€å‡º</button>
            </div>
            <div class="sidebar-header">
                <span class="app-title">æˆ‘çš„ä¾¿ç­¾</span>
                <button class="new-btn" @click="createNote">æ–°å»º</button>
            </div>
            <div class="note-list">
                <div class="note-item" v-for="note in notes" :key="note.id" 
                     :class="{ active: currentNote && currentNote.id === note.id }"
                     @click="selectNote(note)">
                    <div class="note-preview-title">{{ note.attributes.title || 'æ— æ ‡é¢˜' }}</div>
                    <div class="note-preview-content">{{ note.attributes.content || 'æš‚æ— å†…å®¹' }}</div>
                </div>
            </div>
        </div>

        <!-- ç¼–è¾‘åŒº -->
        <div class="main-area" v-if="currentNote">
            <div class="mobile-nav">
                <button class="back-btn" @click="isEditingMobile = false">â€¹ è¿”å›</button>
                <span style="font-size:12px; color:#999">{{ isSaving ? 'åŒæ­¥ä¸­...' : 'å·²åŠ å¯†ä¿å­˜' }}</span>
                <div style="width: 40px"></div>
            </div>

            <div class="editor-wrapper">
                <div class="paper-sheet" :class="[currentNote.attributes.theme || 'theme-white']">
                    <div class="paper-header">
                        <input class="input-title" v-model="currentNote.attributes.title" @input="onInput" placeholder="æ ‡é¢˜">
                    </div>
                    <div class="paper-body">
                        <textarea ref="editor" class="input-content" 
                            v-model="currentNote.attributes.content" @input="onInput"
                            placeholder="å¼€å§‹å†™ä½œ..."></textarea>
                    </div>
                </div>
            </div>

            <div class="toolbar-dock">
                <button class="fab" @click="deleteNote" style="color: #d95e48;">ğŸ—‘ï¸</button>
                <button class="fab primary" @click="generateLongImage">âœ¨</button>
            </div>
        </div>
    </template>
    
    <div id="staging"></div>
</div>

<script>
const { createApp, ref, onMounted, nextTick } = Vue;

const CONFIG = {
    appId: 'E1rPatvQJfGDx7FnsXpGTHN1-gzGzoHsz',
    appKey: 'eqfKH55tCL5dh3oWqF0KkomM',
    serverURL: 'https://e1rpatvq.lc-cn-n1-shared.com'
};

createApp({
    setup() {
        const currentUser = ref(null);
        const authMode = ref('login');
        const authForm = ref({ username: '', password: '' });
        const notes = ref([]);
        const currentNote = ref(null);
        const isEditingMobile = ref(false);
        const isLoading = ref(false);
        const isSaving = ref(false);
        const isGenerating = ref(false);
        const editor = ref(null);
        let saveTimer = null;

        onMounted(() => {
            AV.init(CONFIG);
            currentUser.value = AV.User.current();
            if (currentUser.value) loadNotes();
        });

        // --- è®¤è¯é€»è¾‘ ---
        const handleAuth = async () => {
            if (!authForm.value.username || !authForm.value.password) return alert("è¯·å¡«å†™å®Œæ•´ä¿¡æ¯");
            isLoading.value = true;
            try {
                if (authMode.value === 'login') {
                    currentUser.value = await AV.User.logIn(authForm.value.username, authForm.value.password);
                } else {
                    const user = new AV.User();
                    user.setUsername(authForm.value.username);
                    user.setPassword(authForm.value.password);
                    currentUser.value = await user.signUp();
                }
                loadNotes();
            } catch (e) {
                alert("å¤±è´¥: " + e.message);
            } finally { isLoading.value = false; }
        };

        const logout = () => {
            AV.User.logOut();
            currentUser.value = null;
            notes.value = [];
            currentNote.value = null;
        };

        // --- ç¬”è®°é€»è¾‘ ---
        const loadNotes = async () => {
            isLoading.value = true;
            try {
                const query = new AV.Query('Note');
                // æ ¸å¿ƒï¼šLeanCloud çš„ ACL ä¼šè‡ªåŠ¨è¿‡æ»¤æ‰ç”¨æˆ·æ— æƒæŸ¥çœ‹çš„ç¬”è®°
                query.descending('updatedAt');
                notes.value = await query.find();
            } finally { isLoading.value = false; }
        };

        const createNote = async () => {
            isLoading.value = true;
            try {
                const Note = AV.Object.extend('Note');
                const n = new Note();
                n.set('title', ''); 
                n.set('content', '');
                
                // ğŸ” è®¾ç½®æƒé™ï¼šä»…å½“å‰ç”¨æˆ·å¯è¯»å†™
                const acl = new AV.ACL();
                acl.setReadAccess(currentUser.value, true);
                acl.setWriteAccess(currentUser.value, true);
                n.setACL(acl);

                const saved = await n.save();
                notes.value.unshift(saved);
                selectNote(saved);
            } finally { isLoading.value = false; }
        };

        const selectNote = (note) => {
            currentNote.value = note;
            isEditingMobile.value = true;
            nextTick(autoResize);
        };

        const onInput = () => {
            autoResize();
            if (saveTimer) clearTimeout(saveTimer);
            saveTimer = setTimeout(async () => {
                isSaving.value = true;
                try { await currentNote.value.save(); } 
                finally { isSaving.value = false; }
            }, 1000);
        };

        const autoResize = () => {
            if (editor.value) {
                editor.value.style.height = 'auto';
                editor.value.style.height = editor.value.scrollHeight + 'px';
            }
        };

        const deleteNote = async () => {
            if (!confirm("ç¡®å®šåˆ é™¤å—ï¼Ÿ")) return;
            const id = currentNote.value.id;
            try {
                await currentNote.value.destroy();
                notes.value = notes.value.filter(n => n.id !== id);
                currentNote.value = null;
                isEditingMobile.value = false;
            } catch (e) { alert("åˆ é™¤å¤±è´¥"); }
        };

        const generateLongImage = async () => {
            isGenerating.value = true;
            const staging = document.getElementById('staging');
            staging.innerHTML = '';
            try {
                const clone = document.querySelector('.paper-sheet').cloneNode(true);
                const text = clone.querySelector('textarea');
                const div = document.createElement('div');
                div.style.cssText = "white-space: pre-wrap; font-size:18px; line-height:1.8; padding-bottom:50px;";
                div.innerText = currentNote.value.attributes.content;
                text.parentNode.replaceChild(div, text);
                staging.appendChild(clone);
                const canvas = await html2canvas(clone, { scale: 2, useCORS: true });
                const link = document.createElement('a');
                link.download = `Note_${Date.now()}.png`;
                link.href = canvas.toDataURL("image/png");
                link.click();
            } finally { 
                isGenerating.value = false; 
                staging.innerHTML = '';
            }
        };

        return {
            currentUser, authMode, authForm, notes, currentNote, isEditingMobile, isLoading, isSaving, isGenerating, editor,
            handleAuth, logout, selectNote, createNote, onInput, deleteNote, generateLongImage
        };
    }
}).mount('#app');
</script>
</body>
</html>