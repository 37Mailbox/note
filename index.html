<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Smartisan Notes Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;700;900&family=Noto+Sans+SC:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lxgw-wenkai-screen-webfont@1.1.0/style.css" />
    
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://unpkg.com/leancloud-storage@4.15.0/dist/av-min.js"></script>
    
    <style>
        :root { --primary-red: #d95e48; --bg-dark: #333; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body, html { margin: 0; padding: 0; height: 100%; width: 100%; background: #222; font-family: "PingFang SC", sans-serif; overflow: hidden; }
        
        #app { height: 100vh; width: 100vw; display: flex; }

        /* --- å…¨å±€é®ç½© --- */
        .mask { position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 9000; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; gap: 15px; }
        .auth-card { background: #f2f2f2; width: 90%; max-width: 340px; border-radius: 12px; overflow: hidden; box-shadow: 0 20px 60px rgba(0,0,0,0.5); }
        .auth-header { background: var(--primary-red); padding: 25px; text-align: center; color: white; }
        .auth-body { padding: 25px; }
        .auth-input { width: 100%; padding: 14px; margin-bottom: 12px; border: 1px solid #ccc; border-radius: 6px; font-size: 16px; color:#333; }
        .auth-btn { width: 100%; padding: 14px; background: var(--primary-red); color: white; border: none; border-radius: 6px; font-weight: bold; }

        /* --- ç”µè„‘ç«¯ PC å¸ƒå±€ä¿®å¤ --- */
        .pc-layout { display: flex; width: 100%; height: 100%; background: #e0e0e0; }
        .sidebar { width: 300px; background: #2d2d2d; display: flex; flex-direction: column; flex-shrink: 0; border-right: 1px solid #1a1a1a; }
        .pc-main { flex: 1; overflow-y: auto; padding-top: 50px; padding-bottom: 100px; display: block; } /* å…³é”®ï¼šæ”¹ä¸º block */
        
        /* --- ç§»åŠ¨ç«¯å¸ƒå±€ --- */
        .mobile-layout { width: 100%; height: 100%; background: #fff; display: flex; flex-direction: column; }
        .m-header { height: 50px; background: #f9f9f9; border-bottom: 1px solid #ddd; display: flex; align-items: center; padding: 0 15px; justify-content: space-between; flex-shrink: 0; }
        .m-scroll { flex: 1; overflow-y: auto; -webkit-overflow-scrolling: touch; }

        /* --- åˆ—è¡¨é¡¹ --- */
        .list-header { padding: 20px; color: #eee; border-bottom: 1px solid #3a3a3a; display: flex; justify-content: space-between; align-items: center; }
        .note-item { padding: 18px 20px; border-bottom: 1px solid #333; cursor: pointer; }
        .note-item.active { background: #3d3d3d; border-left: 4px solid var(--primary-red); }
        .note-item .t { color: #eee; font-size: 14px; font-weight: bold; margin-bottom: 5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .note-item .s { color: #888; font-size: 12px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }

        /* --- çº¸å¼  & å†…å®¹ä¿®å¤ --- */
        .paper { 
            width: 100%; max-width: 650px; min-height: 800px; 
            margin: 0 auto; /* PCå±…ä¸­å…³é”® */
            background: #fff; box-shadow: 0 10px 40px rgba(0,0,0,0.1); 
            display: flex; flex-direction: column; height: auto;
        }
        .paper-inner { padding: 50px 50px 100px 50px; height: auto; flex: 1; }
        .input-title { width: 100%; border: none; background: transparent; font-size: 28px; font-weight: 900; margin-bottom: 25px; font-family: inherit; }
        .input-content { 
            width: 100%; border: none; background: transparent; font-size: 18px; line-height: 1.8; 
            resize: none; font-family: inherit; display: block; height: auto;
            text-align: justify; overflow: hidden;
        }

        /* --- å¯¼å‡ºå±‚æ ·å¼ --- */
        .export-node { width: 500px; background: white; }
        .export-img-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 10000; display: flex; flex-direction: column; align-items: center; padding: 20px; overflow-y: auto; }
        .export-img-overlay img { width: 100%; max-width: 400px; box-shadow: 0 0 20px rgba(255,255,255,0.2); margin-bottom: 20px; }

        /* --- ä¸»é¢˜ä¸å­—ä½“ --- */
        .theme-white { background-color: #ffffff !important; color: #333; }
        .theme-grid { background-color: #f9fbfd !important; background-image: url("data:image/svg+xml,%3Csvg width='24' height='24' viewBox='0 0 24 24' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M24 0v24H0' stroke='%23000' stroke-opacity='0.04' stroke-width='0.5' fill='none'/%3E%3C/svg%3E") !important; }
        .theme-retro { background-color: #fcf5e5 !important; color: #5c4b37; }
        .theme-kraft { background-color: #e6d5b8 !important; color: #4a3e2e !important; }

        .font-sans { font-family: "Noto Sans SC", sans-serif; }
        .font-wenkai { font-family: "LXGW WenKai Screen", sans-serif; }
        .font-serif { font-family: "Noto Serif SC", serif; }

        /* --- å·¥å…·æ  --- */
        .toolbar { position: fixed; bottom: 30px; right: 30px; display: flex; flex-direction: column; gap: 12px; z-index: 5000; }
        .fab { width: 56px; height: 56px; border-radius: 50%; background: #fff; border: none; box-shadow: 0 4px 15px rgba(0,0,0,0.2); cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 24px; }
        .fab.primary { background: var(--primary-red); color: white; }
        
        .style-panel { position: absolute; bottom: 75px; right: 0; background: #fff; width: 240px; padding: 20px; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); }
        .dot-row { display: flex; gap: 10px; margin: 10px 0 20px 0; }
        .dot { width: 35px; height: 35px; border-radius: 6px; border: 2px solid #eee; }
        .dot.active { border-color: var(--primary-red); }

        #staging { position: absolute; left: -9999px; top: 0; width: 500px; z-index: -1; }
    </style>
</head>
<body>

<div id="app">
    <!-- ç™»å½• -->
    <div class="mask" v-if="!user">
        <div class="auth-card">
            <div class="auth-header"><h3>Smartisan Notes Pro</h3></div>
            <div class="auth-body">
                <input class="auth-input" v-model="auth.u" placeholder="ç”¨æˆ·å">
                <input class="auth-input" type="password" v-model="auth.p" placeholder="å¯†ç ">
                <button class="auth-btn" @click="handleAuth">{{ isReg ? 'ç«‹å³æ³¨å†Œ' : 'ç™»å½•' }}</button>
                <div @click="isReg=!isReg" style="text-align:center; margin-top:15px; font-size:12px; color:#999; cursor:pointer;">
                    {{ isReg ? 'å»æ³¨å†Œæ–°è´¦å·' : 'å·²æœ‰è´¦å·ï¼Ÿç™»å½•' }}
                </div>
            </div>
        </div>
    </div>

    <!-- çŠ¶æ€ -->
    <div class="mask" v-if="loading || processing">
        <div style="font-size:32px;">{{ processing ? 'ğŸ¨' : 'â˜ï¸' }}</div>
        <div>{{ processing ? 'ç”Ÿæˆé«˜æ¸…å›¾ç‰‡ä¸­...' : 'åŒæ­¥ä¸­...' }}</div>
    </div>

    <!-- æ‰‹æœºç”Ÿå›¾æˆåŠŸåçš„é¢„è§ˆå±‚ (è§£å†³ä¸‹è½½å¤±è´¥) -->
    <div class="export-img-overlay" v-if="mobileImages.length > 0">
        <div style="color:white; margin-bottom:20px; font-weight:bold;">å·²ç”Ÿæˆï¼é•¿æŒ‰å›¾ç‰‡ä¿å­˜åˆ°ç›¸å†Œ</div>
        <img v-for="img in mobileImages" :src="img" :key="img">
        <button @click="mobileImages=[]" style="background:var(--primary-red); color:white; border:none; padding:10px 30px; border-radius:20px;">è¿”å›ç¼–è¾‘</button>
    </div>

    <!-- æ¡Œé¢ç‰ˆ -->
    <div v-if="user && !isMobile" class="pc-layout">
        <div class="sidebar">
            <div class="list-header">
                <span>æˆ‘çš„ä¾¿ç­¾ ({{notes.length}})</span>
                <button @click="createNote" style="background:var(--primary-red); border:none; color:white; padding:5px 12px; border-radius:4px; cursor:pointer;">+ æ–°å»º</button>
            </div>
            <div style="flex:1; overflow-y:auto;">
                <div class="note-item" v-for="n in notes" :key="n.id" :class="{active: currentNote?.id == n.id}" @click="openNote(n)">
                    <div class="t">{{ n.get('title') || 'æ— æ ‡é¢˜' }}</div>
                    <div class="s">{{ n.get('content') || 'æš‚æ— å†…å®¹...' }}</div>
                </div>
            </div>
            <div @click="logout" style="padding:15px; color:#666; font-size:12px; text-align:center; cursor:pointer;">é€€å‡º</div>
        </div>
        <div class="pc-main" v-if="currentNote">
            <div style="text-align:center; margin-bottom:15px; font-size:12px; color:#999;">{{ saveStatus }}</div>
            <div class="paper" :class="[editorData.theme, editorData.font]">
                <div class="paper-inner">
                    <input class="input-title" v-model="editorData.title" @input="triggerSave" placeholder="è¾“å…¥æ ‡é¢˜">
                    <textarea ref="editor" class="input-content" v-model="editorData.content" @input="onInput" placeholder="å†™ç‚¹ä»€ä¹ˆ..."></textarea>
                </div>
            </div>
        </div>
    </div>

    <!-- ç§»åŠ¨ç‰ˆ -->
    <div v-if="user && isMobile" class="mobile-layout">
        <div v-if="!currentNote" class="m-scroll">
            <div class="m-header">
                <span style="font-weight:bold;">å…¨éƒ¨ä¾¿ç­¾</span>
                <button @click="createNote" style="color:var(--primary-red); background:none; border:none; font-size:16px; font-weight:bold;">+ æ–°å»º</button>
            </div>
            <div class="note-item" v-for="n in notes" :key="n.id" @click="openNote(n)" style="border-bottom-color:#eee">
                <div class="t" style="color:#333">{{ n.get('title') || 'æ— æ ‡é¢˜' }}</div>
                <div class="s" style="color:#999">{{ n.get('content') || 'å†…å®¹...' }}</div>
            </div>
            <div @click="logout" style="padding:40px; text-align:center; color:#ccc;">é€€å‡ºç™»å½•</div>
        </div>
        <div v-else style="height:100%; display:flex; flex-direction:column;">
            <div class="m-header">
                <button @click="currentNote=null" style="color:var(--primary-red); background:none; border:none; font-size:16px;">â€¹ åˆ—è¡¨</button>
                <span style="font-size:12px; color:#999">{{ saveStatus }}</span>
                <button @click="deleteNote" style="color:#999; background:none; border:none;">åˆ é™¤</button>
            </div>
            <div class="m-scroll" :class="[editorData.theme, editorData.font]">
                <div style="padding:20px;">
                    <input class="input-title" v-model="editorData.title" @input="triggerSave" placeholder="æ ‡é¢˜">
                    <textarea ref="editor" class="input-content" v-model="editorData.content" @input="onInput" placeholder="å¼€å§‹å†™ä½œ..."></textarea>
                </div>
            </div>
        </div>
    </div>

    <!-- é€šç”¨å·¥å…· -->
    <div class="toolbar" v-if="currentNote">
        <div class="style-panel" v-if="showStyle">
            <div class="dot-row">
                <div v-for="t in themes" :key="t" :class="['dot', t, {active: editorData.theme==t}]" @click="updateAttr('theme', t)"></div>
            </div>
            <select v-model="editorData.font" @change="updateAttr('font', editorData.font)" style="width:100%; padding:8px; margin-bottom:15px;">
                <option value="font-sans">æ ‡å‡†é»‘ä½“</option>
                <option value="font-wenkai">éœé¹œæ–‡æ¥·</option>
                <option value="font-serif">ç»å…¸å®‹ä½“</option>
            </select>
            <div style="font-size:11px; color:#999;">åˆ‡åˆ†æ®µæ•° (é•¿æ–‡å¿…é€‰)</div>
            <select v-model="splitCount" style="width:100%; padding:8px; margin-top:5px;">
                <option :value="1">å•å¼ å›¾</option>
                <option :value="2">åˆ‡ 2 å¼ </option>
                <option :value="3">åˆ‡ 3 å¼ </option>
            </select>
        </div>
        <button class="fab" @click="showStyle=!showStyle">ğŸ¨</button>
        <button class="fab primary" @click="exportImages">âœ¨</button>
    </div>

    <div id="staging"></div>
</div>

<script>
const { createApp, ref, reactive, onMounted, nextTick } = Vue;

const CONFIG = {
    appId: 'E1rPatvQJfGDx7FnsXpGTHN1-gzGzoHsz',
    appKey: 'eqfKH55tCL5dh3oWqF0KkomM',
    serverURL: 'https://e1rpatvq.lc-cn-n1-shared.com'
};

createApp({
    setup() {
        const user = ref(null);
        const auth = reactive({ u: '', p: '' });
        const isReg = ref(false);
        const loading = ref(false);
        const processing = ref(false);
        const isMobile = ref(window.innerWidth < 1024);
        const notes = ref([]);
        const currentNote = ref(null);
        const editorData = reactive({ title: '', content: '', theme: 'theme-white', font: 'font-sans' });
        const saveStatus = ref('å·²åŒæ­¥');
        const mobileImages = ref([]);
        const themes = ['theme-white', 'theme-grid', 'theme-retro', 'theme-kraft'];
        const splitCount = ref(1);
        const showStyle = ref(false);
        const editor = ref(null);
        let saveTimer = null;

        onMounted(() => {
            AV.init(CONFIG);
            user.value = AV.User.current();
            if (user.value) loadNotes();
            window.addEventListener('resize', () => isMobile.value = window.innerWidth < 1024);
        });

        const handleAuth = async () => {
            loading.value = true;
            try {
                if (isReg.value) {
                    const u = new AV.User(); u.setUsername(auth.u); u.setPassword(auth.p);
                    user.value = await u.signUp();
                } else {
                    user.value = await AV.User.logIn(auth.u, auth.p);
                }
                loadNotes();
            } catch (e) { alert(e.message); }
            finally { loading.value = false; }
        };

        const loadNotes = async () => {
            loading.value = true;
            try {
                const q = new AV.Query('Note');
                q.descending('updatedAt');
                const res = await q.find();
                notes.value = res.filter(n => n.get('title') || n.get('content'));
                const lastId = localStorage.getItem('sn_last_id');
                if (lastId) {
                    const last = notes.value.find(n => n.id === lastId);
                    if (last) openNote(last);
                }
            } finally { loading.value = false; }
        };

        const createNote = async () => {
            loading.value = true;
            try {
                const Note = AV.Object.extend('Note');
                const n = new Note();
                n.set('theme', 'theme-white'); n.set('font', 'font-sans');
                const acl = new AV.ACL();
                acl.setReadAccess(user.value, true); acl.setWriteAccess(user.value, true);
                n.setACL(acl);
                const saved = await n.save();
                notes.value.unshift(saved);
                openNote(saved);
            } finally { loading.value = false; }
        };

        const openNote = (n) => {
            currentNote.value = n;
            editorData.title = n.get('title') || '';
            editorData.content = n.get('content') || '';
            editorData.theme = n.get('theme') || 'theme-white';
            editorData.font = n.get('font') || 'font-sans';
            localStorage.setItem('sn_last_id', n.id);
            nextTick(autoHeight);
        };

        const onInput = () => { autoHeight(); triggerSave(); };
        const autoHeight = () => {
            if (editor.value) {
                editor.value.style.height = 'auto';
                editor.value.style.height = editor.value.scrollHeight + 'px';
            }
        };

        const triggerSave = () => {
            saveStatus.value = 'ä¿å­˜ä¸­...';
            if (saveTimer) clearTimeout(saveTimer);
            saveTimer = setTimeout(async () => {
                if (!currentNote.value) return;
                try {
                    currentNote.value.set('title', editorData.title);
                    currentNote.value.set('content', editorData.content);
                    await currentNote.value.save();
                    saveStatus.value = 'äº‘ç«¯å·²åŒæ­¥';
                } catch (e) { saveStatus.value = 'åŒæ­¥å¤±è´¥'; }
            }, 800);
        };

        const updateAttr = (k, v) => {
            editorData[k] = v;
            if (currentNote.value) { currentNote.value.set(k, v); triggerSave(); }
        };

        const deleteNote = async () => {
            if (!confirm("åˆ é™¤åä¸å¯æ¢å¤ï¼Œç¡®å®šï¼Ÿ")) return;
            const target = currentNote.value;
            notes.value = notes.value.filter(n => n.id !== target.id);
            currentNote.value = null;
            try { await target.destroy(); } catch (e) {}
        };

        const exportImages = async () => {
            processing.value = true;
            showStyle.value = false;
            mobileImages.value = [];
            const staging = document.getElementById('staging');
            staging.innerHTML = '';
            
            const count = parseInt(splitCount.value);
            const paragraphs = editorData.content.split('\n');
            const pPerPage = Math.ceil(paragraphs.length / count);

            try {
                for (let i = 0; i < count; i++) {
                    const node = document.createElement('div');
                    node.className = `export-node ${editorData.theme} ${editorData.font}`;
                    let inner = '';
                    if (i === 0) inner += `<div style="padding:60px 45px 20px 45px; border-bottom:1px solid rgba(0,0,0,0.05);"><div style="font-size:30px; font-weight:900;">${editorData.title || 'æ— æ ‡é¢˜'}</div></div>`;
                    else inner += `<div style="height:60px"></div>`;
                    inner += '<div style="padding:40px 45px;">';
                    paragraphs.slice(i * pPerPage, (i + 1) * pPerPage).forEach(p => {
                        inner += `<p style="margin-bottom:22px; font-size:18px; line-height:1.8; text-align:justify;">${p || '<br>'}</p>`;
                    });
                    inner += '</div>';
                    if (i === count - 1) inner += `<div style="text-align:center; padding:50px; opacity:0.2; font-size:11px; letter-spacing:4px;">SMARTISAN NOTES</div>`;
                    
                    node.innerHTML = inner;
                    staging.appendChild(node);
                    await new Promise(r => setTimeout(r, 600));
                    
                    const canvas = await html2canvas(node, {
                        scale: 2, 
                        useCORS: true,
                        logging: false
                    });
                    
                    const dataUrl = canvas.toDataURL("image/png");
                    if (isMobile.value) {
                        mobileImages.value.push(dataUrl);
                    } else {
                        const link = document.createElement('a');
                        link.download = `Note_Part${i+1}.png`;
                        link.href = dataUrl;
                        link.click();
                    }
                    staging.innerHTML = '';
                }
            } catch (e) { alert("å›¾ç‰‡ä½“ç§¯è¿‡å¤§ï¼Œè¯·å¢åŠ åˆ‡åˆ†æ®µæ•°åå†è¯•ã€‚"); }
            finally { processing.value = false; }
        };

        const logout = () => { AV.User.logOut(); localStorage.clear(); location.reload(); };

        return {
            user, auth, isReg, loading, processing, isMobile, notes, currentNote, editorData, saveStatus, themes, showStyle, splitCount, editor, mobileImages,
            handleAuth, createNote, openNote, onInput, updateAttr, deleteNote, exportImages, logout
        };
    }
}).mount('#app');
</script>
</body>
</html>