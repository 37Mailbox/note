<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Smartisan Cloud Lite</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://unpkg.com/leancloud-storage@4.15.0/dist/av-min.js"></script>
    
    <style>
        /* --- æ ¸å¿ƒå¤å¤æ ·å¼ --- */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body, html { margin: 0; padding: 0; height: 100%; background: #3d3d3d; font-family: "PingFang SC", "Helvetica Neue", Helvetica, Arial, sans-serif; overflow: hidden; }
        
        #app { display: flex; height: 100vh; width: 100vw; position: relative; }

        /* --- ä¾§è¾¹æ  (åˆ—è¡¨) --- */
        .sidebar { 
            width: 300px; background: #2d2d2d; border-right: 1px solid #1a1a1a;
            display: flex; flex-direction: column; z-index: 10; flex-shrink: 0;
        }
        .sidebar-header { padding: 20px; border-bottom: 1px solid #3a3a3a; display: flex; justify-content: space-between; align-items: center; }
        .app-title { color: #eee; font-weight: 600; font-size: 16px; }
        .new-btn { background: #d95e48; color: white; border: none; padding: 6px 14px; border-radius: 4px; font-weight: bold; cursor: pointer; }

        .note-list { flex: 1; overflow-y: auto; -webkit-overflow-scrolling: touch; }
        .note-item { 
            padding: 16px 20px; border-bottom: 1px solid #333; cursor: pointer; 
            transition: 0.2s; position: relative; 
        }
        .note-item:active { background: #353535; }
        .note-item.active { background: #404040; }
        .note-item.active::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 4px; background: #d95e48; }
        .note-preview-title { color: #eee; font-size: 15px; font-weight: bold; margin-bottom: 4px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .note-preview-content { color: #888; font-size: 12px; height: 34px; line-height: 1.4; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .note-preview-date { color: #555; font-size: 11px; margin-top: 6px; display: flex; justify-content: space-between; }

        /* --- ä¸»ç¼–è¾‘åŒº --- */
        .main-area { 
            flex: 1; background: #e0e0e0; display: flex; flex-direction: column; 
            position: relative; overflow: hidden; z-index: 20;
        }
        
        /* æ‰‹æœºç«¯å¯¼èˆªæ¡ - ä¿®æ­£é«˜åº¦å’Œé˜´å½± */
        .mobile-nav { 
            display: none; height: 50px; background: #f8f8f8; border-bottom: 1px solid #ccc;
            align-items: center; padding: 0 15px; justify-content: space-between; flex-shrink: 0;
        }
        .back-btn { border: none; background: transparent; color: #d95e48; font-size: 16px; font-weight: bold; cursor: pointer; }
        .save-status { font-size: 11px; color: #999; }

        /* ç¼–è¾‘å™¨èƒŒæ™¯ - æ¶ˆé™¤ç™½æ¡†æ„Ÿ */
        .editor-wrapper { 
            flex: 1; overflow-y: auto; -webkit-overflow-scrolling: touch;
            padding: 30px 15px; display: flex; justify-content: center;
        }

        /* --- çº¸å¼ æ ·å¼è¿˜åŸ --- */
        .paper-sheet { 
            width: 100%; max-width: 640px; min-height: 800px; height: fit-content;
            background: #fff; box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            border-radius: 2px; position: relative; transition: all 0.3s;
        }
        .paper-header { padding: 40px 40px 10px 40px; }
        .input-title { 
            width: 100%; border: none; outline: none; background: transparent;
            font-size: 24px; font-weight: bold; color: inherit;
            border-bottom: 1px solid rgba(0,0,0,0.05); padding-bottom: 10px;
        }
        .input-author { 
            width: 100%; border: none; outline: none; background: transparent;
            font-size: 14px; color: inherit; opacity: 0.5; margin-top: 10px;
        }
        .paper-body { padding: 10px 40px 60px 40px; }
        .input-content { 
            width: 100%; border: none; outline: none; background: transparent;
            font-size: 18px; line-height: 1.8; color: inherit; font-family: inherit;
            resize: none; overflow: hidden; min-height: 500px;
        }

        /* ä¸»é¢˜å®šä¹‰ */
        .theme-white { background-color: #ffffff !important; color: #333; }
        .theme-grid { background-color: #f7f9fc !important; background-image: linear-gradient(#e6e9ef 1px, transparent 1px), linear-gradient(90deg, #e6e9ef 1px, transparent 1px) !important; background-size: 30px 30px !important; color: #2c3e50; }
        .theme-retro { background-color: #fdf6e3 !important; background-image: radial-gradient(#d6ceaa 1px, transparent 1px) !important; background-size: 20px 20px !important; color: #5c4b37; }
        .theme-dark { background-color: #2b2b2b !important; color: #bbb !important; }

        .font-sans { font-family: sans-serif; }
        .font-serif { font-family: "Songti SC", serif; }

        /* --- å·¥å…·æ  --- */
        .toolbar-dock { position: absolute; bottom: 30px; right: 30px; display: flex; flex-direction: column; gap: 12px; align-items: flex-end; z-index: 100; }
        .fab { width: 50px; height: 50px; border-radius: 50%; background: #fff; border: none; box-shadow: 0 4px 12px rgba(0,0,0,0.2); cursor: pointer; font-size: 20px; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
        .fab.primary { background: #d95e48; color: #fff; }
        .style-panel { background: #fff; padding: 15px; border-radius: 10px; box-shadow: 0 5px 20px rgba(0,0,0,0.3); width: 220px; margin-bottom: 10px; }
        .panel-label { font-size: 11px; color: #999; margin-bottom: 8px; display: block; }
        .theme-opt-row { display: flex; gap: 8px; }
        .theme-opt { flex: 1; height: 30px; border-radius: 4px; border: 1px solid #ddd; cursor: pointer; }
        .theme-opt.active { border: 2px solid #d95e48; }

        /* --- æ‰‹æœºç«¯å…³é”®é€‚é… --- */
        @media (max-width: 768px) {
            .sidebar { 
                width: 100%; position: absolute; left: 0; top: 0; 
                transform: translateX(0); transition: 0.3s;
            }
            .main-area { 
                width: 100%; position: absolute; left: 0; top: 0; height: 100%;
                transform: translateX(100%); transition: 0.3s;
            }
            /* æ¿€æ´»çŠ¶æ€ */
            #app.show-editor .sidebar { transform: translateX(-20%); opacity: 0.5; }
            #app.show-editor .main-area { transform: translateX(0); box-shadow: -10px 0 20px rgba(0,0,0,0.2); }

            .mobile-nav { display: flex; }
            .editor-wrapper { padding: 0; background: #fff; } /* æ‰‹æœºç«¯èƒŒæ™¯å˜ç™½ï¼Œæ¶ˆé™¤ç™½æ¡†æ„Ÿ */
            .paper-sheet { 
                max-width: none; box-shadow: none; border-radius: 0; min-height: 100%; 
            }
            .paper-header { padding: 25px 20px 10px 20px; }
            .paper-body { padding: 10px 20px 100px 20px; }
            .toolbar-dock { bottom: 20px; right: 20px; }
        }

        .mask { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 1000; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; }
        #staging { position: absolute; top: -9999px; left: -9999px; width: 640px; }
    </style>
</head>
<body>

<div id="app" :class="{'show-editor': isEditingMobile}">
    <!-- çŠ¶æ€é®ç½© -->
    <div class="mask" v-if="isLoading || isGenerating">
        <div style="font-size: 30px; margin-bottom: 15px;">{{ isGenerating ? 'âœ¨' : 'â˜ï¸' }}</div>
        <div>{{ isGenerating ? 'æ­£åœ¨ç”Ÿæˆç¾å›¾...' : 'åŒæ­¥äº‘ç«¯ä¸­...' }}</div>
    </div>

    <!-- åˆ—è¡¨ -->
    <div class="sidebar">
        <div class="sidebar-header">
            <span class="app-title">äº‘ç«¯ä¾¿ç­¾</span>
            <button class="new-btn" @click="createNote">æ–°å»º</button>
        </div>
        <div class="note-list">
            <div class="note-item" v-for="note in notes" :key="note.id" 
                 :class="{ active: currentNote && currentNote.id === note.id }"
                 @click="selectNote(note)">
                <div class="note-preview-title">{{ note.attributes.title || 'æ— æ ‡é¢˜' }}</div>
                <div class="note-preview-content">{{ note.attributes.content || 'æš‚æ— å†…å®¹' }}</div>
                <div class="note-preview-date">
                    <span>{{ formatTime(note.updatedAt) }}</span>
                    <span>{{ note.hasPendingChanges ? 'ğŸ•’' : 'â˜ï¸' }}</span>
                </div>
            </div>
        </div>
    </div>

    <!-- ç¼–è¾‘åŒº -->
    <div class="main-area" v-if="currentNote">
        <div class="mobile-nav">
            <button class="back-btn" @click="isEditingMobile = false">â€¹ è¿”å›</button>
            <span class="save-status">{{ isSaving ? 'æ­£åœ¨ä¿å­˜...' : 'å·²è‡ªåŠ¨ä¿å­˜' }}</span>
            <div style="width: 40px"></div>
        </div>

        <div class="editor-wrapper">
            <div class="paper-sheet" :class="[currentNote.attributes.theme || 'theme-white', currentNote.attributes.font || 'font-sans']">
                <div class="paper-header">
                    <input class="input-title" v-model="currentNote.attributes.title" @input="onInput" placeholder="æ ‡é¢˜">
                    <input class="input-author" v-model="currentNote.attributes.author" @input="onInput" placeholder="ä½œè€… (å¯é€‰)">
                </div>
                <div class="paper-body">
                    <textarea ref="editor" class="input-content" 
                        v-model="currentNote.attributes.content" @input="onInput"
                        placeholder="ç‚¹å‡»å¼€å§‹å†™ä½œ..."></textarea>
                </div>
            </div>
        </div>

        <!-- æµ®åŠ¨å·¥å…·æ  -->
        <div class="toolbar-dock">
            <div class="style-panel" v-if="showStyle">
                <span class="panel-label">èƒŒæ™¯ä¸»é¢˜</span>
                <div class="theme-opt-row">
                    <div class="theme-opt theme-white" @click="setStyle('theme', 'theme-white')" :class="{active: currentNote.attributes.theme === 'theme-white'}"></div>
                    <div class="theme-opt theme-grid" @click="setStyle('theme', 'theme-grid')" :class="{active: currentNote.attributes.theme === 'theme-grid'}"></div>
                    <div class="theme-opt theme-retro" @click="setStyle('theme', 'theme-retro')" :class="{active: currentNote.attributes.theme === 'theme-retro'}"></div>
                    <div class="theme-opt theme-dark" @click="setStyle('theme', 'theme-dark')" :class="{active: currentNote.attributes.theme === 'theme-dark'}"></div>
                </div>
                <span class="panel-label" style="margin-top:10px;">å­—ä½“é€‰æ‹©</span>
                <select v-model="currentNote.attributes.font" @change="onInput" style="width:100%; padding:4px;">
                    <option value="font-sans">æ ‡å‡†é»‘ä½“</option>
                    <option value="font-serif">äººæ–‡å®‹ä½“</option>
                </select>
            </div>
            <button class="fab" @click="showStyle = !showStyle">ğŸ¨</button>
            <button class="fab" @click="deleteNote" style="color: #d95e48;">ğŸ—‘ï¸</button>
            <button class="fab primary" @click="generateLongImage">âœ¨</button>
        </div>
    </div>

    <!-- ç¦»å±æ¸²æŸ“åŒº -->
    <div id="staging"></div>
</div>

<script>
const { createApp, ref, onMounted, nextTick } = Vue;

const CONFIG = {
    appId: 'E1rPatvQJfGDx7FnsXpGTHN1-gzGzoHsz',
    appKey: 'eqfKH55tCL5dh3oWqF0KkomM',
    serverURL: 'https://e1rpatvq.lc-cn-n1-shared.com'
};

createApp({
    setup() {
        const notes = ref([]);
        const currentNote = ref(null);
        const isEditingMobile = ref(false);
        const isLoading = ref(false);
        const isSaving = ref(false);
        const isGenerating = ref(false);
        const showStyle = ref(false);
        const editor = ref(null);
        let saveTimer = null;

        const init = async () => {
            AV.init(CONFIG);
            isLoading.value = true;
            try {
                const query = new AV.Query('Note');
                query.descending('updatedAt');
                notes.value = await query.find();
                if (window.innerWidth > 768 && notes.value.length > 0) {
                    selectNote(notes.value[0]);
                }
            } catch (e) { alert("åŠ è½½å¤±è´¥"); }
            finally { isLoading.value = false; }
        };

        const selectNote = (note) => {
            currentNote.value = note;
            isEditingMobile.value = true; // æ‰‹æœºç«¯æ¿€æ´»è§†å›¾
            showStyle.value = false;
            nextTick(autoResize);
        };

        const createNote = async () => {
            isLoading.value = true;
            try {
                const Note = AV.Object.extend('Note');
                const n = new Note();
                n.set('title', ''); n.set('content', ''); n.set('theme', 'theme-white');
                const acl = new AV.ACL();
                acl.setPublicReadAccess(true); acl.setPublicWriteAccess(true);
                n.setACL(acl);
                const saved = await n.save();
                notes.value.unshift(saved);
                selectNote(saved);
            } finally { isLoading.value = false; }
        };

        const deleteNote = async () => {
            if (!confirm("ç¡®å®šåˆ é™¤å—ï¼Ÿ")) return;
            const id = currentNote.value.id;
            isLoading.value = true;
            try {
                // å…ˆåœ¨æœ¬åœ°åˆ—è¡¨ä¸­å‰”é™¤ï¼Œç¡®ä¿â€œç§’åˆ â€
                const idx = notes.value.findIndex(n => n.id === id);
                if (idx > -1) notes.value.splice(idx, 1);
                
                await currentNote.value.destroy();
                isEditingMobile.value = false;
                currentNote.value = null;
            } catch (e) {
                console.log("äº‘ç«¯å·²ä¸å­˜åœ¨");
            } finally { isLoading.value = false; }
        };

        const onInput = () => {
            autoResize();
            if (!currentNote.value) return;
            currentNote.value.hasPendingChanges = true;
            if (saveTimer) clearTimeout(saveTimer);
            saveTimer = setTimeout(async () => {
                isSaving.value = true;
                try {
                    await currentNote.value.save();
                    currentNote.value.hasPendingChanges = false;
                } finally { isSaving.value = false; }
            }, 1000);
        };

        const autoResize = () => {
            if (editor.value) {
                editor.value.style.height = 'auto';
                editor.value.style.height = editor.value.scrollHeight + 'px';
            }
        };

        const setStyle = (k, v) => {
            currentNote.value.set(k, v);
            onInput();
        };

        const formatTime = (d) => {
            if (!d) return '';
            const date = new Date(d);
            return `${date.getMonth()+1}/${date.getDate()} ${date.getHours()}:${String(date.getMinutes()).padStart(2,'0')}`;
        };

        const generateLongImage = async () => {
            isGenerating.value = true;
            showStyle.value = false;
            const staging = document.getElementById('staging');
            staging.innerHTML = '';
            
            try {
                // åˆ›å»ºä¸€ä¸ªå®Œç¾çš„å…‹éš†èŠ‚ç‚¹è¿›è¡Œæ¸²æŸ“ï¼Œé¿å…å±å¹•æ»šåŠ¨å½±å“
                const clone = document.querySelector('.paper-sheet').cloneNode(true);
                // ä¿®æ­£é«˜åº¦ï¼Œè®©å†…å®¹å…¨éƒ¨å±•å¼€
                const text = clone.querySelector('textarea');
                const div = document.createElement('div');
                div.style.cssText = "white-space: pre-wrap; font-size:18px; line-height:1.8; padding-bottom:50px;";
                div.innerText = currentNote.value.attributes.content;
                text.parentNode.replaceChild(div, text);
                
                staging.appendChild(clone);
                
                const canvas = await html2canvas(clone, {
                    scale: 2,
                    useCORS: true,
                    backgroundColor: null
                });
                
                const link = document.createElement('a');
                link.download = `CloudNote_${Date.now()}.png`;
                link.href = canvas.toDataURL("image/png");
                link.click();
            } catch (e) { alert("ç”Ÿæˆå¤±è´¥"); }
            finally { 
                isGenerating.value = false; 
                staging.innerHTML = '';
            }
        };

        onMounted(init);

        return {
            notes, currentNote, isEditingMobile, isLoading, isSaving, isGenerating, showStyle, editor,
            selectNote, createNote, deleteNote, onInput, setStyle, formatTime, generateLongImage
        };
    }
}).mount('#app');
</script>
</body>
</html>