<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Smartisan Notes Pro</title>
    <!-- å­—ä½“ï¼šæ–‡æ¥· + å®‹ä½“ + é»‘ä½“ -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;700;900&family=Noto+Sans+SC:wght@400;700&family=ZCOOL+XiaoWei&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lxgw-wenkai-screen-webfont@1.1.0/style.css" />
    
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://unpkg.com/leancloud-storage@4.15.0/dist/av-min.js"></script>
    
    <style>
        :root { --primary-red: #d95e48; --bg-dark: #3d3d3d; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body, html { margin: 0; padding: 0; height: 100%; width: 100%; background: #2d2d2d; font-family: "PingFang SC", sans-serif; overflow: hidden; }
        
        #app { height: 100vh; width: 100vw; display: flex; }

        /* --- ç™»å½•å±‚ --- */
        .mask { position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 9000; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; gap: 15px; }
        .auth-card { background: #f2f2f2; width: 90%; max-width: 340px; border-radius: 12px; overflow: hidden; box-shadow: 0 20px 60px rgba(0,0,0,0.5); }
        .auth-header { background: var(--primary-red); padding: 25px; text-align: center; color: white; }
        .auth-body { padding: 25px; }
        .auth-input { width: 100%; padding: 14px; margin-bottom: 12px; border: 1px solid #ccc; border-radius: 6px; font-size: 16px; color:#333; }
        .auth-btn { width: 100%; padding: 14px; background: var(--primary-red); color: white; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; }

        /* --- PCç«¯å¸ƒå±€ --- */
        .pc-layout { display: flex; width: 100%; height: 100%; background: #e0e0e0; }
        .sidebar { width: 300px; background: #2d2d2d; display: flex; flex-direction: column; border-right: 1px solid #1a1a1a; }
        .main-content { flex: 1; overflow-y: auto; display: flex; flex-direction: column; align-items: center; padding: 50px 20px; }
        
        /* --- ç§»åŠ¨ç«¯å¸ƒå±€ --- */
        .mobile-layout { width: 100%; height: 100%; background: #fff; display: flex; flex-direction: column; }
        .m-header { height: 50px; background: #f8f8f8; border-bottom: 1px solid #ddd; display: flex; align-items: center; padding: 0 15px; justify-content: space-between; flex-shrink: 0; }
        .m-scroll { flex: 1; overflow-y: auto; background: #fff; }

        /* --- åˆ—è¡¨é€šç”¨ --- */
        .list-title { padding: 20px; color: #eee; font-weight: bold; border-bottom: 1px solid #3a3a3a; display: flex; justify-content: space-between; align-items: center; }
        .note-item { padding: 18px 20px; border-bottom: 1px solid #333; cursor: pointer; }
        .note-item.active { background: #3d3d3d; border-left: 4px solid var(--primary-red); }
        .note-item .t { color: #eee; font-size: 14px; font-weight: bold; margin-bottom: 5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .note-item .s { color: #888; font-size: 12px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }

        /* --- ç¼–è¾‘çº¸å¼  --- */
        .paper { 
            width: 100%; max-width: 600px; min-height: 800px; height: auto;
            background: #fff; box-shadow: 0 10px 40px rgba(0,0,0,0.1); 
            display: flex; flex-direction: column; position: relative;
        }
        .paper-inner { padding: 40px 45px 80px 45px; }
        .input-title { width: 100%; border: none; background: transparent; font-size: 28px; font-weight: 900; margin-top: 10px; margin-bottom: 20px; font-family: inherit; }
        .input-content { 
            width: 100%; border: none; background: transparent; font-size: 18px; line-height: 1.8; 
            resize: none; font-family: inherit; overflow: hidden; /* å…³é”®ï¼šäº¤ç»™ JS è®¡ç®—é«˜åº¦ */
        }

        /* --- å¯¼å‡ºæ¸²æŸ“ --- */
        .export-node { width: 500px; background: white; position: relative; }
        .export-header { padding: 60px 45px 20px 45px; border-bottom: 1px solid rgba(0,0,0,0.05); }

        /* --- ä¸»é¢˜ä¸å­—ä½“ --- */
        .theme-white { background-color: #ffffff !important; color: #333; }
        .theme-grid { background-color: #f9fbfd !important; background-image: url("data:image/svg+xml,%3Csvg width='24' height='24' viewBox='0 0 24 24' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M24 0v24H0' stroke='%23000' stroke-opacity='0.04' stroke-width='0.5' fill='none'/%3E%3C/svg%3E") !important; }
        .theme-retro { background-color: #fcf5e5 !important; color: #5c4b37; }
        .theme-kraft { background-color: #e6d5b8 !important; color: #4a3e2e !important; }

        .font-sans { font-family: "Noto Sans SC", sans-serif; }
        .font-wenkai { font-family: "LXGW WenKai Screen", sans-serif; }
        .font-serif { font-family: "Noto Serif SC", serif; }

        /* --- å·¥å…·æ  --- */
        .toolbar { position: fixed; bottom: 30px; right: 30px; display: flex; flex-direction: column; gap: 12px; z-index: 5000; }
        .fab { width: 56px; height: 56px; border-radius: 50%; background: #fff; border: none; box-shadow: 0 4px 15px rgba(0,0,0,0.2); cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 22px; }
        .fab.primary { background: var(--primary-red); color: white; }
        
        .style-card { position: absolute; bottom: 75px; right: 0; background: #fff; width: 240px; padding: 20px; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); }
        .dot-row { display: flex; gap: 8px; margin: 10px 0 20px 0; }
        .dot { width: 32px; height: 32px; border-radius: 6px; border: 2px solid #eee; cursor: pointer; }
        .dot.active { border-color: var(--primary-red); }

        #staging { position: absolute; left: -9999px; top: 0; width: 500px; visibility: hidden; }
    </style>
</head>
<body>

<div id="app">
    <!-- ç™»å½•é®ç½© -->
    <div class="mask" v-if="!user">
        <div class="auth-card">
            <div class="auth-header"><h3>Smartisan Notes Pro</h3></div>
            <div class="auth-body">
                <input class="auth-input" v-model="auth.u" placeholder="ç”¨æˆ·å">
                <input class="auth-input" type="password" v-model="auth.p" placeholder="å¯†ç ">
                <button class="auth-btn" @click="handleAuth">{{ isReg ? 'æ³¨å†Œå¹¶ç™»å½•' : 'ç«‹å³ç™»å½•' }}</button>
                <div @click="isReg=!isReg" style="text-align:center; margin-top:15px; font-size:12px; color:#999; cursor:pointer;">
                    {{ isReg ? 'å·²æœ‰è´¦å·ï¼Ÿå»ç™»å½•' : 'æ–°ç”¨æˆ·ï¼Ÿç‚¹å‡»æ³¨å†Œ' }}
                </div>
            </div>
        </div>
    </div>

    <!-- å¤„ç†ä¸­é®ç½© -->
    <div class="mask" v-if="loading || processing">
        <div style="font-size:32px;">{{ processing ? 'ğŸ¨' : 'â˜ï¸' }}</div>
        <div>{{ processing ? 'æ­£åœ¨ç”Ÿæˆé•¿å›¾...' : 'åŒæ­¥äº‘ç«¯æ•°æ®...' }}</div>
    </div>

    <!-- æ¡Œé¢å¸ƒå±€ -->
    <div v-if="user && !isMobile" class="pc-layout">
        <div class="sidebar">
            <div class="list-title">
                <span>ä¾¿ç­¾ ({{notes.length}})</span>
                <button @click="createNote" style="background:var(--primary-red); color:white; border:none; padding:4px 12px; border-radius:4px; font-weight:bold; cursor:pointer;">+ æ–°å»º</button>
            </div>
            <div style="flex:1; overflow-y:auto;">
                <div class="note-item" v-for="n in notes" :key="n.id" :class="{active: currentNote?.id == n.id}" @click="openNote(n)">
                    <div class="t">{{ n.get('title') || 'æ— æ ‡é¢˜' }}</div>
                    <div class="s">{{ n.get('content') || 'æš‚æ— å†…å®¹...' }}</div>
                </div>
            </div>
            <div @click="logout" style="padding:15px; color:#666; font-size:12px; text-align:center; cursor:pointer;">é€€å‡ºå½“å‰è´¦å·</div>
        </div>
        <div class="main-content" v-if="currentNote">
            <div style="margin-bottom:12px; font-size:12px; color:#888;">{{ saveStatus }}</div>
            <div class="paper" :class="[currentNote.get('theme') || 'theme-white', currentNote.get('font') || 'font-sans']">
                <div class="paper-inner">
                    <input class="input-title" v-model="editorData.title" @input="triggerSave" placeholder="è¾“å…¥æ ‡é¢˜">
                    <textarea ref="editor" class="input-content" v-model="editorData.content" @input="onInput" placeholder="åœ¨æ­¤å¼€å§‹å†™ä½œ..."></textarea>
                </div>
            </div>
        </div>
    </div>

    <!-- ç§»åŠ¨ç«¯å¸ƒå±€ -->
    <div v-if="user && isMobile" class="mobile-layout">
        <!-- åˆ—è¡¨ -->
        <div v-if="!currentNote" class="m-scroll">
            <div class="m-header">
                <span style="font-weight:bold;">æˆ‘çš„ä¾¿ç­¾</span>
                <button @click="createNote" style="color:var(--primary-red); background:none; border:none; font-size:16px; font-weight:bold;">+ æ–°å»º</button>
            </div>
            <div class="note-item" style="border-bottom-color:#eee" v-for="n in notes" :key="n.id" @click="openNote(n)">
                <div class="t" style="color:#333">{{ n.get('title') || 'æ— æ ‡é¢˜' }}</div>
                <div class="s" style="color:#888">{{ n.get('content') || 'æš‚æ— å†…å®¹...' }}</div>
            </div>
            <div @click="logout" style="padding:40px; text-align:center; color:#ccc; font-size:12px;">é€€å‡ºç™»å½•</div>
        </div>
        <!-- ç¼–è¾‘ -->
        <div v-else style="height:100%; display:flex; flex-direction:column;">
            <div class="m-header">
                <button @click="currentNote=null" style="color:var(--primary-red); background:none; border:none; font-size:16px;">â€¹ åˆ—è¡¨</button>
                <span style="font-size:12px; color:#999">{{ saveStatus }}</span>
                <button @click="deleteNote" style="color:#999; background:none; border:none;">åˆ é™¤</button>
            </div>
            <div class="m-scroll" :class="[editorData.theme, editorData.font]">
                <div style="padding:20px;">
                    <input class="input-title" v-model="editorData.title" @input="triggerSave" placeholder="æ ‡é¢˜">
                    <textarea ref="editor" class="input-content" v-model="editorData.content" @input="onInput" placeholder="ç‚¹å‡»è¾“å…¥å†…å®¹..."></textarea>
                </div>
            </div>
        </div>
    </div>

    <!-- å·¥å…·æ  (ä»…ç¼–è¾‘æ—¶) -->
    <div class="toolbar" v-if="currentNote">
        <div class="style-card" v-if="showStyle">
            <div style="font-size:11px; color:#999;">èƒŒæ™¯ä¿¡çº¸</div>
            <div class="dot-row">
                <div v-for="t in themes" :key="t" :class="['dot', t, {active: editorData.theme==t}]" @click="updateAttr('theme', t)"></div>
            </div>
            <div style="font-size:11px; color:#999;">æ­£æ–‡å­—ä½“</div>
            <select v-model="editorData.font" @change="updateAttr('font', editorData.font)" style="width:100%; padding:6px; margin:8px 0 15px 0;">
                <option value="font-sans">æ ‡å‡†é»‘ä½“</option>
                <option value="font-wenkai">éœé¹œæ–‡æ¥·</option>
                <option value="font-serif">ç»å…¸å®‹ä½“</option>
            </select>
            <div style="font-size:11px; color:#999;">æ™ºèƒ½åˆ‡åˆ†</div>
            <select v-model="splitCount" style="width:100%; padding:6px; margin:8px 0 0 0;">
                <option :value="1">å•å¼ é•¿å›¾</option>
                <option :value="2">åˆ†ä¸º 2 å¼ </option>
                <option :value="3">åˆ†ä¸º 3 å¼ </option>
            </select>
        </div>
        <button class="fab" @click="showStyle=!showStyle">ğŸ¨</button>
        <button v-if="!isMobile" class="fab" @click="deleteNote">ğŸ—‘ï¸</button>
        <button class="fab primary" @click="exportImages">âœ¨</button>
    </div>

    <!-- ç¦»å±æ¸²æŸ“å®¹å™¨ -->
    <div id="staging"></div>
</div>

<script>
const { createApp, ref, reactive, onMounted, nextTick } = Vue;

const CONFIG = {
    appId: 'E1rPatvQJfGDx7FnsXpGTHN1-gzGzoHsz',
    appKey: 'eqfKH55tCL5dh3oWqF0KkomM',
    serverURL: 'https://e1rpatvq.lc-cn-n1-shared.com'
};

createApp({
    setup() {
        const user = ref(null);
        const auth = reactive({ u: '', p: '' });
        const isReg = ref(false);
        const loading = ref(false);
        const processing = ref(false);
        const isMobile = ref(window.innerWidth < 1024);
        
        const notes = ref([]);
        const currentNote = ref(null);
        const editorData = reactive({ title: '', content: '', theme: 'theme-white', font: 'font-sans' });
        const saveStatus = ref('å·²ä¿å­˜');
        const themes = ['theme-white', 'theme-grid', 'theme-retro', 'theme-kraft'];
        const splitCount = ref(1);
        const showStyle = ref(false);
        const editor = ref(null);
        let saveTimer = null;

        onMounted(() => {
            AV.init(CONFIG);
            user.value = AV.User.current();
            if (user.value) loadNotes();
            window.addEventListener('resize', () => isMobile.value = window.innerWidth < 1024);
        });

        const handleAuth = async () => {
            if (!auth.u || !auth.p) return alert("ä¿¡æ¯ä¸å…¨");
            loading.value = true;
            try {
                if (isReg.value) {
                    const u = new AV.User(); u.setUsername(auth.u); u.setPassword(auth.p);
                    user.value = await u.signUp();
                } else {
                    user.value = await AV.User.logIn(auth.u, auth.p);
                }
                loadNotes();
            } catch (e) { alert("æ“ä½œå¤±è´¥: " + e.message); }
            finally { loading.value = false; }
        };

        const loadNotes = async () => {
            loading.value = true;
            try {
                const q = new AV.Query('Note');
                q.descending('updatedAt');
                const res = await q.find();
                // 1. å¼ºåŠ›æ¸…æ´—ï¼šè¿‡æ»¤æ‰å®Œå…¨ä¸ºç©ºçš„æ­»æ•°æ®
                notes.value = res.filter(n => (n.get('title') || n.get('content')));
                
                const lastId = localStorage.getItem('last_id');
                if (lastId) {
                    const last = notes.value.find(n => n.id === lastId);
                    if (last) openNote(last);
                }
            } finally { loading.value = false; }
        };

        const createNote = async () => {
            loading.value = true;
            try {
                const Note = AV.Object.extend('Note');
                const n = new Note();
                n.set('title', ''); n.set('content', '');
                n.set('theme', 'theme-white'); n.set('font', 'font-sans');
                
                const acl = new AV.ACL();
                acl.setReadAccess(user.value, true);
                acl.setWriteAccess(user.value, true);
                n.setACL(acl);

                const saved = await n.save();
                notes.value.unshift(saved);
                openNote(saved);
            } finally { loading.value = false; }
        };

        const openNote = (n) => {
            currentNote.value = n;
            editorData.title = n.get('title') || '';
            editorData.content = n.get('content') || '';
            editorData.theme = n.get('theme') || 'theme-white';
            editorData.font = n.get('font') || 'font-sans';
            localStorage.setItem('last_id', n.id);
            nextTick(autoHeight);
        };

        const onInput = () => { autoHeight(); triggerSave(); };
        const autoHeight = () => {
            if (editor.value) {
                editor.value.style.height = 'auto';
                editor.value.style.height = (editor.value.scrollHeight) + 'px';
            }
        };

        const triggerSave = () => {
            saveStatus.value = 'ä¿å­˜ä¸­...';
            if (saveTimer) clearTimeout(saveTimer);
            saveTimer = setTimeout(async () => {
                if (!currentNote.value) return;
                try {
                    currentNote.value.set('title', editorData.title);
                    currentNote.value.set('content', editorData.content);
                    await currentNote.value.save();
                    saveStatus.value = 'å·²ä¿å­˜åˆ°äº‘ç«¯';
                } catch (e) { saveStatus.value = 'ä¿å­˜å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ'; }
            }, 800);
        };

        const updateAttr = (k, v) => {
            editorData[k] = v;
            if (currentNote.value) {
                currentNote.value.set(k, v);
                triggerSave();
            }
        };

        const deleteNote = async () => {
            if (!confirm("ç¡®å®šå½»åº•åˆ é™¤å—ï¼Ÿ")) return;
            const target = currentNote.value;
            try {
                // å³ä½¿äº‘ç«¯å› ä¸º ACL æƒé™æ— æ³•åˆ é™¤æ—§æ•°æ®ï¼Œæœ¬åœ°ä¹Ÿå¼ºåˆ¶ç§»é™¤
                notes.value = notes.value.filter(n => n.id !== target.id);
                currentNote.value = null;
                localStorage.removeItem('last_id');
                await target.destroy();
            } catch (e) {
                console.log("äº‘ç«¯åŒæ­¥åˆ é™¤è·³è¿‡ï¼Œæœ¬åœ°å·²æ¸…ç†");
            }
        };

        const exportImages = async () => {
            processing.value = true;
            showStyle.value = false;
            const staging = document.getElementById('staging');
            staging.style.visibility = 'visible'; // æˆªå–å‰å¿…é¡»å˜ä¸ºå¯è§
            staging.innerHTML = '';
            
            const count = parseInt(splitCount.value);
            const paragraphs = editorData.content.split('\n');
            const pPerPage = Math.ceil(paragraphs.length / count);

            try {
                for (let i = 0; i < count; i++) {
                    const node = document.createElement('div');
                    node.className = `export-node ${editorData.theme} ${editorData.font}`;
                    
                    let inner = '';
                    if (i === 0) {
                        inner += `<div class="export-header"><div style="font-size:30px; font-weight:900;">${editorData.title || 'æ— æ ‡é¢˜'}</div></div>`;
                    } else {
                        inner += `<div style="height:60px"></div>`;
                    }

                    inner += '<div style="padding:40px 45px;">';
                    paragraphs.slice(i * pPerPage, (i + 1) * pPerPage).forEach(p => {
                        inner += `<p style="margin-bottom:20px; font-size:18px; line-height:1.8; text-align:justify;">${p || '<br>'}</p>`;
                    });
                    inner += '</div>';
                    
                    if (i === count - 1) {
                        inner += `<div style="text-align:center; padding:50px; opacity:0.2; font-size:11px; letter-spacing:4px;">SMARTISAN NOTES</div>`;
                    } else {
                        inner += `<div style="height:40px"></div>`;
                    }

                    node.innerHTML = inner;
                    staging.appendChild(node);
                    
                    // é¢„ç•™è¶³å¤Ÿæ¸²æŸ“æ—¶é—´
                    await new Promise(r => setTimeout(r, 600));
                    
                    const canvas = await html2canvas(node, {
                        scale: isMobile.value ? 2.0 : 2.5, // æ‰‹æœºç«¯é™ä½å€ç‡é˜²æ­¢æº¢å‡º
                        useCORS: true,
                        backgroundColor: null
                    });

                    const link = document.createElement('a');
                    link.download = `Note_Part${i+1}.png`;
                    link.href = canvas.toDataURL("image/png");
                    link.click();
                    staging.innerHTML = '';
                }
            } catch (e) {
                alert("ç”Ÿæˆå¤±è´¥ï¼Œå»ºè®®å¢åŠ é•¿å›¾åˆ†æ®µæ•°é‡ã€‚");
            } finally {
                staging.style.visibility = 'hidden';
                processing.value = false;
            }
        };

        const logout = () => { AV.User.logOut(); localStorage.clear(); location.reload(); };

        return {
            user, auth, isReg, loading, processing, isMobile, notes, currentNote, editorData, saveStatus, themes, showStyle, splitCount, editor,
            handleAuth, createNote, openNote, onInput, updateAttr, deleteNote, exportImages, logout
        };
    }
}).mount('#app');
</script>
</body>
</html>